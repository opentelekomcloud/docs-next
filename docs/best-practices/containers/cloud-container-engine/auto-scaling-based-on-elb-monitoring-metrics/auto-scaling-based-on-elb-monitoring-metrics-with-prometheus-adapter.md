---
id: auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter
title: Auto Scaling Based on ELB Monitoring Metrics with Prometheus Adapter
tags: [cce, elb, hpa, prometheus, prometheus-adapter, cloudeye]
---

# Auto Scaling Based on ELB Monitoring Metrics with Prometheus Adapter

This article demonstrates how to implement auto scaling using the Prometheus Adapter with ELB monitoring metrics, enabling HPA to consume custom metrics from Prometheus.

## Prerequisites
Before following this guide, ensure you have completed the environment setup as described [here](auto-scaling-based-on-elb-monitoring-metrics.md).

Additionally, you need:

- Basic understanding of Kubernetes HPA (Horizontal Pod Autoscaler)
- Familiarity with Prometheus metrics and queries

## Solution Design

This section describes an auto scaling solution based on ELB monitoring metrics. 

The key of this solution is to convert the data that is obtained from the ELB metric and exported to the Prometheus to the metric data that can be identified by HPA, and then perform auto scaling based on the converted data.

The implementation scheme is as follows:

- Convert the Prometheus data into the Kubernetes metric API for the HPA controller to use
- Set an HPA rule to use ELB monitoring data as auto scaling metrics


![**Figure 1** ELB traffic flows and monitoring
data](/img/docs/best-practices/containers/cloud-container-engine/en-us_image_0000001160642449.png)


## Installing prometheus-adapter

Next, and last step, of the installation sequence is the deployment of **prometheus-adapter** that will give an additional custom metrics api endpoint that will bind our custom **CloudEye** metrics with **HPA** **./install-adapter.sh**:

```
envsubst < prometheus-adapter/override.tpl  prometheus-adapter/override.yaml
sleep 15

helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

helm upgrade --install --values prometheus-adapter/override.yaml prometheus-adapter prometheus-community/prometheus-adapter -n monitoring
```

The configuration values used for the prometheus-adapter chart will be autogenerated at **deploy/manifests/prometheus-adapter/override.yaml**. You could diff them with the default values **default.yaml** to figure out the changes.

## Creating an HPA Policy

After the data reported by the exporter to Prometheus is converted into the Kubernetes metric API by using the Prometheus adapter, you can create an HPA policy for auto scaling.

1. Create an HPA policy. The inbound traffic of the ELB load balancer is used to trigger scale-out. When the value of `m7_in_Bps` (inbound traffic rate) exceeds `1000`, the nginx Deployment will be scaled.

   ```yaml
   apiVersion: autoscaling/v2
   kind: HorizontalPodAutoscaler
   metadata:
     name: nginx
     namespace: default
   spec:
     scaleTargetRef:
       apiVersion: apps/v1
       kind: Deployment
       name: nginx
     minReplicas: 1
     maxReplicas: 10
     metrics:
       - type: Object
         object:
           metric:
             name: elb01_listener_m7_in_Bps
           describedObject:
             apiVersion: v1
             kind: Service
             name: cloudeye-exporter
           target:
             type: Value
             value: 1000
   ```

    ![**Figure 2** Created HPA Policy](/img/docs/best-practices/containers/cloud-container-engine/en-us_image_0000001606847653.png)

2.  After the HPA policy is created, perform a pressure test on the
    workload (accessing the pods through ELB). Then, the HPA controller
    determines whether scaling is required based on the configured
    value.

    In the *Events* dialog box, obtain scaling records in the *Kubernetes Event* column.

    ![**Figure 3** Scaling events](/img/docs/best-practices/containers/cloud-container-engine/en-us_image_0000001606845825.png)
