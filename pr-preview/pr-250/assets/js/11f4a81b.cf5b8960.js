"use strict";(self.webpackChunkdocs_next=self.webpackChunkdocs_next||[]).push([[41245],{25650:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"best-practices/computing/elastic-cloud-server/building-highly-available-web-server-clusters-with-keepalived","title":"Building Highly Available Web Server Clusters with Keepalived","description":"Virtual IP addresses are used for active and standby switchover of ECSs to achieve high availability. This way if one ECS goes down for some reason, the other one can take over and services continue uninterrupted. This article uses CentOS Stream release 9 ECSs as an example to describe how to set up highly available web server clusters using Keepalived and Nginx.","source":"@site/docs/best-practices/computing/elastic-cloud-server/building-highly-available-web-server-clusters-with-keepalived.md","sourceDirName":"best-practices/computing/elastic-cloud-server","slug":"/best-practices/computing/elastic-cloud-server/building-highly-available-web-server-clusters-with-keepalived","permalink":"/docs-next/pr-preview/pr-250/docs/best-practices/computing/elastic-cloud-server/building-highly-available-web-server-clusters-with-keepalived","draft":false,"unlisted":false,"editUrl":"https://github.com/opentelekomcloud/docs-next/tree/main/docs/best-practices/computing/elastic-cloud-server/building-highly-available-web-server-clusters-with-keepalived.md","tags":[{"inline":true,"label":"ecs","permalink":"/docs-next/pr-preview/pr-250/docs/tags/ecs"},{"inline":true,"label":"high-availability","permalink":"/docs-next/pr-preview/pr-250/docs/tags/high-availability"},{"inline":true,"label":"keepalived","permalink":"/docs-next/pr-preview/pr-250/docs/tags/keepalived"}],"version":"current","frontMatter":{"id":"building-highly-available-web-server-clusters-with-keepalived","title":"Building Highly Available Web Server Clusters with Keepalived","tags":["ecs","high-availability","keepalived"]},"sidebar":"bestPracticesSidebar","previous":{"title":"Configuring Message Accumulation Monitoring","permalink":"/docs-next/pr-preview/pr-250/docs/best-practices/application-services/distributed-message-service/configuring-message-accumulation-monitoring"},"next":{"title":"Migrating Service Data Across Accounts (Data Disks)","permalink":"/docs-next/pr-preview/pr-250/docs/best-practices/computing/image-management-service/migrating-service-data-across-accounts-data-disks"}}');var t=s(74848),r=s(28453);const l={id:"building-highly-available-web-server-clusters-with-keepalived",title:"Building Highly Available Web Server Clusters with Keepalived",tags:["ecs","high-availability","keepalived"]},c="Building Highly Available Web Server Clusters with Keepalived",d={},a=[{value:"Solution Design",id:"solution-design",level:2},{value:"Network Topology",id:"network-topology",level:3},{value:"Procedure",id:"procedure",level:3},{value:"Creating the Cluster",id:"creating-the-cluster",level:2},{value:"Verifying High Availability",id:"verifying-high-availability",level:2}];function o(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"building-highly-available-web-server-clusters-with-keepalived",children:"Building Highly Available Web Server Clusters with Keepalived"})}),"\n",(0,t.jsx)(n.p,{children:"Virtual IP addresses are used for active and standby switchover of ECSs to achieve high availability. This way if one ECS goes down for some reason, the other one can take over and services continue uninterrupted. This article uses CentOS Stream release 9 ECSs as an example to describe how to set up highly available web server clusters using Keepalived and Nginx."}),"\n",(0,t.jsx)(n.h2,{id:"solution-design",children:"Solution Design"}),"\n",(0,t.jsx)(n.p,{children:"A web cluster consists of multiple web servers and a load balancer.\nAccess requests will first be received by the load balancer, which then\ndistributes the requests to backend web servers based on the load\nbalancing policy.In this document, Nginx is used to implement load balancing."}),"\n",(0,t.jsx)(n.h3,{id:"network-topology",children:"Network Topology"}),"\n",(0,t.jsx)(n.p,{children:"The data planning could follow one of the implementations below:"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"No."}),(0,t.jsx)(n.th,{children:"Item"}),(0,t.jsx)(n.th,{children:"Quantity"}),(0,t.jsx)(n.th,{children:"Specification"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"1"}),(0,t.jsx)(n.td,{children:"VPC"}),(0,t.jsx)(n.td,{children:"1"}),(0,t.jsx)(n.td,{children:"192.168.0.0/16"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{children:"Subnet"}),(0,t.jsx)(n.td,{children:"1"}),(0,t.jsx)(n.td,{children:"192.168.0.0/24"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"2"}),(0,t.jsx)(n.td,{children:"ECS"}),(0,t.jsx)(n.td,{children:"2"}),(0,t.jsx)(n.td,{children:"1 vCPU, 1 GB, CentOS Stream release 9"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{children:"IP address"}),(0,t.jsx)(n.td,{children:"2"}),(0,t.jsx)(n.td,{children:"ecs-HA1: 192.168.0.10 ecs-HA2: 192.168.0.20"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"3"}),(0,t.jsx)(n.td,{children:"EIP"}),(0,t.jsx)(n.td,{children:"1"}),(0,t.jsx)(n.td,{children:"80.158.xxx.xxx"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{children:"Virtual IP address"}),(0,t.jsx)(n.td,{children:"1"}),(0,t.jsx)(n.td,{children:"192.168.0.100"})]})]})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Configure the two ECSs in the same subnet to work in the active/standby mode using Keepalived."}),"\n",(0,t.jsx)(n.li,{children:"Bind a single virtual IP address to the two ECSs."}),"\n",(0,t.jsx)(n.li,{children:"Bind the virtual IP address to an EIP, then you can access the active and standby ECSs bound with the virtual IP address from the Internet."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://arch-assets-dev.obs.eu-de.otc.t-systems.com/static/img/docs/best-practices/computing/elastic-cloud-server/en-us_image_0285681028.png",alt:"Figure 1 Network topology"})}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Select a region based on your service requirements."}),"\n",(0,t.jsxs)(n.li,{children:["All cloud resources ",(0,t.jsx)(n.strong,{children:"must be in the same region"}),"."]}),"\n"]})}),"\n",(0,t.jsx)(n.h3,{id:"procedure",children:"Procedure"}),"\n",(0,t.jsx)(n.p,{children:"The overall operation process is as follows:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://arch-assets-dev.obs.eu-de.otc.t-systems.com/static/img/docs/best-practices/computing/elastic-cloud-server/en-us_image_0285681029.png",alt:"Figure 2 Operation process"})}),"\n",(0,t.jsx)(n.h2,{id:"creating-the-cluster",children:"Creating the Cluster"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.em,{children:"Create a VPC and a subnet."})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Log in to the management console."}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.em,{children:"Service List"}),". Under ",(0,t.jsx)(n.em,{children:"Networking"}),", click ",(0,t.jsx)(n.em,{children:"Virtual Private Cloud"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.em,{children:"Create VPC"}),".\nSet required parameters as prompted based on the following table:"]}),"\n"]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Parameter"}),(0,t.jsx)(n.th,{children:"Example Value"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Name (of the VPC)"}),(0,t.jsx)(n.td,{children:"vpc-HA"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"CIDR Block (of the VPC)"}),(0,t.jsx)(n.td,{children:"192.168.0.0/16"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Name (of the subnet)"}),(0,t.jsx)(n.td,{children:"subnet-HA"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"CIDR Block (of the subnet)"}),(0,t.jsx)(n.td,{children:"192.168.0.0/24"})]})]})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.em,{children:"Create Now"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.em,{children:"Apply for required cloud resources."}),"\na.  Create ECSs."]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Log in to the management console."}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.em,{children:"Service List"}),". Under ",(0,t.jsx)(n.em,{children:"Computing"}),", click ",(0,t.jsx)(n.em,{children:"Elastic Cloud Server"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.em,{children:"Create ECS"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["On the ",(0,t.jsx)(n.em,{children:"Create ECS"})," page, set parameters as prompted. For details, see"]}),"\n",(0,t.jsx)(n.li,{children:"Set the ECS name to ecs-HA1 and ecs-HA2."}),"\n"]}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsx)(n.p,{children:"In this example, no data disk is purchased. You can buy data\ndisks based on service requirements and ensure their service\ndata consistency."})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"(Optional) Configure security group rules to ensure that the\ntwo ECSs can communicate with each other."}),"\n",(0,t.jsx)(n.p,{children:"In this example, the two ECSs are in the same security group\nand can communicate with each other through the internal\nnetwork by default. In this case, you do not need to\nconfigure rules."}),"\n",(0,t.jsxs)(n.p,{children:["If two ECSs are in different security groups, you need to\nadd inbound security group rules for the two ECSs. For\ndetails, see ",(0,t.jsx)(n.a,{href:"https://docs.otc.t-systems.com/elastic-cloud-server/umn/security/security_groups/security_group_configuration_examples.html#en-us-topic-0140323152-en-us-topic-0118534011-section14197522283",children:"Enabling ECSs in Different Security Groups to\nCommunicate with Each Other Through an Internal\nNetwork"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.img,{src:"https://arch-assets-dev.obs.eu-de.otc.t-systems.com/static/img/docs/best-practices/computing/elastic-cloud-server/en-us_image_0000001176019342.png",alt:"Figure 3 Add Inbound Rule"}),"\nb.  Assign an EIP."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Log in to the management console."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Click ",(0,t.jsx)(n.em,{children:"Service List"}),". Under ",(0,t.jsx)(n.em,{children:"Network"}),", click ",(0,t.jsx)(n.em,{children:"Elastic IP"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Click ",(0,t.jsx)(n.em,{children:"Assign EIP"})," and set parameters as prompted. For\ndetails, see\n",(0,t.jsx)(n.code,{children:"Table 1"}),".\nc.  Assign a virtual IP address."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Log in to the management console."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Click ",(0,t.jsx)(n.em,{children:"Service List"}),". Under ",(0,t.jsx)(n.em,{children:"Network"}),", click ",(0,t.jsx)(n.em,{children:"Virtual\nPrivate Cloud"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["In the navigation pane on the left, click ",(0,t.jsx)(n.em,{children:"Subnets"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"In the subnet list, locate the target subnet and click its\nname."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["On the ",(0,t.jsx)(n.em,{children:"IP Addresses"})," tab page, click ",(0,t.jsx)(n.em,{children:"Assign Virtual IP\nAddress"})," and set parameters as prompted."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.em,{children:"Configure the ECSs."}),"\na.  Configure the ecs-HA1."]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Bind EIP (",(0,t.jsx)(n.code,{children:"80.158.xxx.xxx"}),") to ",(0,t.jsx)(n.code,{children:"ecs-HA1"}),"."]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Log in to the management console."}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.em,{children:"Service List"}),". Under ",(0,t.jsx)(n.em,{children:"Computing"}),", click\n",(0,t.jsx)(n.em,{children:"Elastic Cloud Server"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["In the ECS list, click the name of ",(0,t.jsx)(n.code,{children:"ecs-HA1"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Click the ",(0,t.jsx)(n.em,{children:"EIPs"})," tab and then ",(0,t.jsx)(n.em,{children:"Bind EIP"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["On the ",(0,t.jsx)(n.em,{children:"Bind EIP"})," page, select a NIC and an EIP, and\nclick ",(0,t.jsx)(n.em,{children:"OK"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Connect to ",(0,t.jsx)(n.code,{children:"ecs-HA1"})," using SSH and run the following command\nto install the Nginx and Keepalived packages and related\ndependency packages:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"yum install nginx keepalived -y\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Run the following command to edit the ",(0,t.jsx)(n.strong,{children:"nginx"}),"\nconfiguration file and save it:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"**vim /etc/nginx/nginx.conf**\n"})}),"\n",(0,t.jsx)(n.p,{children:"An example is provided as follows:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'user root;\nworker_processes 1;\n#error_log logs/error.log;\n#error_log logs/error.log notice;\n#error_log logs/error.log info;\n#pid logs/nginx.pid;\nevents {\n       worker_connections 1024;\n}\nhttp {\n     include mime.types;\n     default_type application/octet-stream;\n     #log_format main \'$remote_addr  - $remote_user [$time_local] "$request" \'\n     # \'$status $body_bytes_sent  "$http_referer" \'\n     # \'"$http_user_agent"  "$http_x_forwarded_for"\';\n     #access_log logs/access.log main;\n     sendfile on;\n     #tcp_nopush on;\n     #keepalive_timeout 0;\n     keepalive_timeout 65;\n     #gzip on;\n     server {\n            listen 80;\n            server_name localhost;\n             #charset koi8-r;\n             #access_log logs/host.access.log main;\n            location / {\n                        root html;\n                        index index.html index.html;\n                      }\n                      #error_page 404  /404.html;\n                      # redirect server error pages to the static page /50x.html\n                      error_page 500 502 503 504 /50x.html;\n                      location =  /50x.html {\n                                            root html;\n                                            }\n\n          }\n   }\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Run the following command to edit the ",(0,t.jsx)(n.strong,{children:"index.html"})," file\nand save the file:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"vim /usr/share/nginx/html/index.html\n"})}),"\n",(0,t.jsx)(n.p,{children:"An example is provided as follows:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Welcome to ECS-HA1\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Run the following commands to set the automatic startup of\nNginx upon ECS startup:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"systemctl enable nginx\nsystemctl start nginx.service\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Verify the access to a single Nginx node."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://arch-assets-dev.obs.eu-de.otc.t-systems.com/static/img/docs/best-practices/computing/elastic-cloud-server/en-us_image_0285681030.png",alt:"Figure 4 ECS-HA1 access verification"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Run the following command to edit the ",(0,t.jsx)(n.strong,{children:"keepalived"}),"\nconfiguration file and save it:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"vim /etc/keepalived/keepalived.conf\n"})}),"\n",(0,t.jsx)(n.p,{children:"An example is provided as follows:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'! Configuration File for keepalived\nglobal_defs {\nrouter_id master-node\n}\nvrrp_script chk_http_port {\n                      script  "/etc/keepalived/chk_nginx.sh"\n                      interval 2\n                      weight -5\n                      fall 2\n                      rise 1\n                     }\nvrrp_instance VI_1 {\n                state MASTER\n                interface ens3\n                mcast_src_ip 192.168.0.10\n                virtual_router_id 51\n                priority 101\n                advert_int 1\n                authentication {\n                              auth_type PASS\n                              auth_pass 1111\n                             }\n                unicast_src_ip 192.168.0.10\n                virtual_ipaddress {\n                             192.168.0.100\n                             }\ntrack_script {\n           chk_http_port\n            }\n}\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Run the following command to edit the ",(0,t.jsx)(n.strong,{children:"nginx"})," monitoring\nscript and save it:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"vim /etc/keepalived/chk_nginx.sh\n"})}),"\n",(0,t.jsx)(n.p,{children:"An example is provided as follows:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\ncounter=$(ps -C nginx --no-heading|wc -l)\nif [ "${counter}" = "0"  ]; then\n  systemctl start nginx.service\n   sleep 2\n   counter=$(ps -C nginx  --no-heading|wc -l)\n   if [ "${counter}" =  "0" ]; then\n      systemctl stop keepalived.service\n   fi\nfi\n'})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"chmod +x /etc/keepalived/chk_nginx.sh adduser keepalived_script\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Run the following commands to set the automatic startup of\nKeepalived upon ECS startup:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"systemctl enable keepalived\nsystemctl start keepalived.service\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["b.  Configure the ",(0,t.jsx)(n.code,{children:"ecs-HA2"}),".\n10. Unbind EIP (",(0,t.jsx)(n.code,{children:"80.158.xxx.xxx"}),") from ",(0,t.jsx)(n.code,{children:"ecs-HA1"}),"."]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Log in to the management console."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Click ",(0,t.jsx)(n.strong,{children:"Service List"}),". Under ",(0,t.jsx)(n.strong,{children:"Computing"}),", click\n",(0,t.jsx)(n.strong,{children:"Elastic Cloud Server"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"In the ECS list, click the name of ecs-HA1."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Click the ",(0,t.jsx)(n.strong,{children:"EIPs"})," tab."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Locate the row that contains the EIP (80.158.xxx.xxx),\nand click ",(0,t.jsx)(n.strong,{children:"Unbind"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Bind EIP (80.158.xxx.xxx) to ecs-HA2."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Log in to the management console."}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.strong,{children:"Service List"}),". Under ",(0,t.jsx)(n.strong,{children:"Computing"}),", click\n",(0,t.jsx)(n.strong,{children:"Elastic Cloud Server"}),"."]}),"\n",(0,t.jsx)(n.li,{children:"In the ECS list, click the name of ecs-HA2."}),"\n",(0,t.jsxs)(n.li,{children:["Click the ",(0,t.jsx)(n.strong,{children:"EIPs"})," tab."]}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.strong,{children:"Bind EIP"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Select a NIC and an EIP and click ",(0,t.jsx)(n.strong,{children:"OK"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Connect to ecs-HA2 using SSH and run the following command\nto install the Nginx and Keepalived packages and related\ndependency packages:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"yum install nginx keepalived -y"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Run the following command to edit the ",(0,t.jsx)(n.strong,{children:"nginx.conf"}),"\nconfiguration file:"]}),"\n",(0,t.jsx)(n.p,{children:"vim /etc/nginx/nginx.conf"}),"\n",(0,t.jsx)(n.p,{children:"An example is provided as follows:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'user root;\nworker_processes 1;\n#error_log logs/error.log;\n#error_log logs/error.log notice;\n#error_log logs/error.log info;\n#pid logs/nginx.pid;\nevents {\n      worker_connections 1024;\n      }\nhttp {\n     include mime.types;\n     default_type application/octet-stream;\n     #log_format main \'$remote_addr  - $remote_user [$time_local] "$request" \'\n     # \'$status $body_bytes_sent  "$http_referer" \'\n     # \'"$http_user_agent"  "$http_x_forwarded_for"\';\n     #access_log logs/access.log main;\n     sendfile on;\n     #tcp_nopush on;\n     #keepalive_timeout 0;\n     keepalive_timeout 65;\n     #gzip on;\n     server {\n          listen 80;\n          server_name localhost;\n          #charset koi8-r;\n          #access_log logs/host.access.log main;\n          location / {\n                    root html;\n                    index index.html index.htm;\n                    }\n          #error_page 404  /404.html;\n          # redirect server error pages to the static page /50x.html\n          error_page 500 502 503 504 /50x.html;\n          location =  /50x.html {\n                              root html;\n                              }\n          }\n}\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Run the following command to edit the ",(0,t.jsx)(n.strong,{children:"index.html"})," file:"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"vim /usr/share/nginx/html/index.html"})}),"\n",(0,t.jsx)(n.p,{children:"An example is provided as follows:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Welcome to ECS-HA2\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Run the following commands to set the automatic startup of\nNginx upon ECS startup:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"systemctl enable nginx"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"systemctl start nginx.service"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Test the access to a single Nginx node."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://arch-assets-dev.obs.eu-de.otc.t-systems.com/static/img/docs/best-practices/computing/elastic-cloud-server/en-us_image_0285681031.png",alt:"Figure 5 ECS-HA2 verification result"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Run the following command to edit the Keepalived\nconfiguration file:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"vim /etc/keepalived/keepalived.conf"})}),"\n",(0,t.jsx)(n.p,{children:"An example is provided as follows:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'! Configuration File for keepalived\nglobal_defs {\nrouter_id master-node\n}\nvrrp_script chk_http_port {\n          script  "/etc/keepalived/chk_nginx.sh"\n          interval 2\n          weight -5\n          fall 2\n          rise 1\n        }\nvrrp_instance VI_1 {\n     state BACKUP\n     interface ens3\n     mcast_src_ip 192.168.0.20\n     virtual_router_id 51\n     priority 100\n     advert_int 1\n     authentication {\n               auth_type PASS\n               auth_pass 1111\n               }\n     unicast_src_ip 192.168.0.20\n     virtual_ipaddress {\n                    192.168.0.100\n                    }\ntrack_script {\n     chk_http_port\n     }\n}\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Run the following command to edit the ",(0,t.jsx)(n.strong,{children:"nginx"})," monitoring\nscript and add execute permissions:"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"vim /etc/keepalived/chk_nginx.sh"})}),"\n",(0,t.jsx)(n.p,{children:"An example is provided as follows:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'#!/bin/bash\ncounter=$(ps -C nginx --no-heading|wc -l)\nif [ "${counter}" = "0"  ]; then\n     systemctl start nginx.service\n     sleep 2\n     counter=$(ps -C nginx  --no-heading|wc -l)\n     if [ "${counter}" =  "0" ]; then\n          systemctl stop keepalived.service\n     fi\nfi\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"chmod +x /etc/keepalived/chk_nginx.sh"})," ",(0,t.jsx)(n.strong,{children:"adduser\nkeepalived_script"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Run the following commands to set the automatic startup of\nKeepalived upon ECS startup:"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"systemctl enable keepalived"})," ",(0,t.jsx)(n.strong,{children:"systemctl start\nkeepalived"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Bind a virtual IP address to an ECS."}),"\na.  Unbind EIP (80.158.xxx.xxx) from ecs-HA2."]}),"\n",(0,t.jsx)(n.p,{children:"b. Bind the virtual IP address to ecs-HA1."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Log in to the management console."}),"\n",(0,t.jsxs)(n.li,{children:["Click ",(0,t.jsx)(n.strong,{children:"Service List"}),". Under ",(0,t.jsx)(n.strong,{children:"Network"}),", click ",(0,t.jsx)(n.strong,{children:"Virtual\nPrivate Cloud"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["In the navigation pane on the left, click ",(0,t.jsx)(n.strong,{children:"Subnets"}),"."]}),"\n",(0,t.jsx)(n.li,{children:"In the subnet list, locate the target subnet and click its\nname."}),"\n",(0,t.jsxs)(n.li,{children:["Click the ",(0,t.jsx)(n.strong,{children:"IP Addresses"})," tab, locate the row that contains\nthe target virtual IP address, and click ",(0,t.jsx)(n.strong,{children:"Bind to Server"}),"\nin the ",(0,t.jsx)(n.strong,{children:"Operation"})," column."]}),"\n",(0,t.jsx)(n.li,{children:"On the page that is displayed, select ecs HA1."}),"\n",(0,t.jsxs)(n.li,{children:["Bind the virtual IP address to ecs HA1. For details, see\n",(0,t.jsx)(n.a,{href:"https://docs.otc.t-systems.com/virtual-private-cloud/umn/virtual_ip_address/binding_a_virtual_ip_address_to_an_eip_or_ecs.html",children:"Binding a Virtual IP Address to an EIP or\nECS"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"c.  Bind the virtual IP address to ecs-HA2 by referring to"}),"\n",(0,t.jsxs)(n.p,{children:["d.  Bind the virtual IP address to the EIP ",(0,t.jsx)(n.code,{children:"80.158.xxx.xxx"}),".\n8.  Log in to the management console.\n9.  Click ",(0,t.jsx)(n.em,{children:"Service List"}),". Under ",(0,t.jsx)(n.em,{children:"Network"}),", click ",(0,t.jsx)(n.em,{children:"Virtual\nPrivate Cloud"}),".\n10. In the navigation pane on the left, click ",(0,t.jsx)(n.em,{children:"Subnets"}),".\n11. In the subnet list, locate the target subnet and click its\nname.\n12. Click the ",(0,t.jsx)(n.em,{children:"IP Addresses"})," tab, locate the row that contains\nthe target virtual IP address, and click ",(0,t.jsx)(n.em,{children:"Bind to EIP"})," in\nthe ",(0,t.jsx)(n.em,{children:"Operation"})," column.\n13. On the page that is displayed, select the EIP\n(",(0,t.jsx)(n.code,{children:"80.158.xxx.xxx"}),").\n14. Click ",(0,t.jsx)(n.em,{children:"OK"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"verifying-high-availability",children:"Verifying High Availability"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Restart ecs-HA1 and ecs-HA2 through the management console."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Remotely log in to ecs-HA1 through the management console."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Run the following command to check whether the virtual IP address is\nbound to the eth0 NIC of ecs-HA1:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"ip addr show"})}),"\n",(0,t.jsxs)(n.p,{children:["As shown in ",(0,t.jsx)(n.em,{children:"Figure 6"}),", the virtual IP address has been bound to the ",(0,t.jsx)(n.code,{children:"ens3"})," NIC of ",(0,t.jsx)(n.code,{children:"ecs-HA1"}),"."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://arch-assets-dev.obs.eu-de.otc.t-systems.com/static/img/docs/best-practices/computing/elastic-cloud-server/en-us_image_0285681032.png",alt:"Figure 6 Virtual IP address of ecs-HA1"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Use a browser to access the EIP and check whether the web page on\necs-HA1 can be accessed."}),"\n",(0,t.jsxs)(n.p,{children:["If the information shown in ",(0,t.jsx)(n.em,{children:"Figure 7"}),"`* is displayed, the access is normal."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://arch-assets-dev.obs.eu-de.otc.t-systems.com/static/img/docs/best-practices/computing/elastic-cloud-server/en-us_image_0285681030.png",alt:"Figure 7 ecs-HA1 access verification"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Run the following command to disable Keepalived on ecs-HA1:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"systemctl stop keepalived.service"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Run the following command to check whether ecs-HA2 has taken over\nthe virtual IP address:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"ip addr show"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://arch-assets-dev.obs.eu-de.otc.t-systems.com/static/img/docs/best-practices/computing/elastic-cloud-server/en-us_image_0285681032.png",alt:"Figure 8 Virtual IP address of ecs-HA2"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Use a browser to access the EIP and check whether the web page on\necs-HA2 can be accessed."}),"\n",(0,t.jsxs)(n.p,{children:["If the information shown in ",(0,t.jsx)(n.em,{children:"Figure 9"})," is displayed, the access is normal."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://arch-assets-dev.obs.eu-de.otc.t-systems.com/static/img/docs/best-practices/computing/elastic-cloud-server/en-us_image_0285681031.png",alt:"Figure 9 ecs-HA2 access verification"})}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>c});var i=s(96540);const t={},r=i.createContext(t);function l(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);