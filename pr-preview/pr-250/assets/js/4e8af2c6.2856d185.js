"use strict";(self.webpackChunkdocs_next=self.webpackChunkdocs_next||[]).push([[40552],{23015:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"blueprints/by-use-case/analytics/umami/deploy-umami-cce","title":"Deploy Umami on CCE","description":"In this blueprint we are going to set up Umami on Open Telekom Cloud\'s Cloud Container Engine (CCE), leveraging Kubernetes for scalability and flexibility. For the database backend, we will use the Zalando PostgreSQL Operator to provision and manage a PostgreSQL cluster within the CCE environment.","source":"@site/docs/blueprints/by-use-case/analytics/umami/deploy-umami-cce.md","sourceDirName":"blueprints/by-use-case/analytics/umami","slug":"/blueprints/by-use-case/analytics/umami/deploy-umami-cce","permalink":"/docs-next/pr-preview/pr-250/docs/blueprints/by-use-case/analytics/umami/deploy-umami-cce","draft":false,"unlisted":false,"editUrl":"https://github.com/opentelekomcloud/docs-next/tree/main/docs/blueprints/by-use-case/analytics/umami/deploy-umami-cce.md","tags":[{"inline":true,"label":"umami","permalink":"/docs-next/pr-preview/pr-250/docs/tags/umami"},{"inline":true,"label":"analytics","permalink":"/docs-next/pr-preview/pr-250/docs/tags/analytics"},{"inline":true,"label":"cce","permalink":"/docs-next/pr-preview/pr-250/docs/tags/cce"},{"inline":true,"label":"postgresql","permalink":"/docs-next/pr-preview/pr-250/docs/tags/postgresql"}],"version":"current","frontMatter":{"id":"deploy-umami-cce","title":"Deploy Umami on CCE","tags":["umami","analytics","cce","postgresql"]},"sidebar":"blueprintsSidebar","previous":{"title":"Umami","permalink":"/docs-next/pr-preview/pr-250/docs/blueprints/by-use-case/analytics/umami/umami"},"next":{"title":"Using RDS for PostgreSQL to Set Up Umami on ECS","permalink":"/docs-next/pr-preview/pr-250/docs/blueprints/by-use-case/analytics/umami/using-rds-postgresql-to-setup-umami-on-ecs"}}');var i=a(74848),t=a(28453);const r={id:"deploy-umami-cce",title:"Deploy Umami on CCE",tags:["umami","analytics","cce","postgresql"]},l="Deploy Umami on CCE",o={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Installing Zalando Postgres Operator",id:"installing-zalando-postgres-operator",level:2},{value:"Installing Umami",id:"installing-umami",level:2},{value:"Provisioning a Database",id:"provisioning-a-database",level:3},{value:"Deploying Umami",id:"deploying-umami",level:3},{value:"Creating an Elastic Load Balancer",id:"creating-an-elastic-load-balancer",level:2},{value:"Exposing Umami",id:"exposing-umami",level:2},{value:"Creating a Service",id:"creating-a-service",level:3},{value:"Creating an Ingress (optional)",id:"creating-an-ingress-optional",level:3},{value:"Verification",id:"verification",level:2}];function m(e){const n={admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"deploy-umami-on-cce",children:"Deploy Umami on CCE"})}),"\n",(0,i.jsx)(n.p,{children:"In this blueprint we are going to set up Umami on Open Telekom Cloud's Cloud Container Engine (CCE), leveraging Kubernetes for scalability and flexibility. For the database backend, we will use the Zalando PostgreSQL Operator to provision and manage a PostgreSQL cluster within the CCE environment."}),"\n",(0,i.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsxs)(n.p,{children:["We are going to need a CCE Cluster (its provisioning is out of the scope of this blueprint) and the ",(0,i.jsx)(n.strong,{children:"zalando-postgres-operator"}),". This operator automates the management of PostgreSQL clusters on Kubernetes, handling tasks like scaling, backups, and failover. It simplifies the deployment and maintenance of a highly available PostgreSQL database within the CCE cluster. Additionally we are going to need an Elastic Load Balancer in order to expose Umami."]}),"\n",(0,i.jsx)(n.h2,{id:"installing-zalando-postgres-operator",children:"Installing Zalando Postgres Operator"}),"\n",(0,i.jsx)(n.p,{children:"We are going to install the operator by using the provided Helm chart:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"helm repo add postgres-operator-charts https://opensource.zalando.com/postgres-operator/charts/postgres-operator\nhelm repo update\n\nhelm install postgres-operator postgres-operator-charts/postgres-operator\n"})}),"\n",(0,i.jsx)(n.h2,{id:"installing-umami",children:"Installing Umami"}),"\n",(0,i.jsx)(n.h3,{id:"provisioning-a-database",children:"Provisioning a Database"}),"\n",(0,i.jsx)(n.p,{children:"As we priorly discussed, we are going to use zalando-postgres-operator in order to provision a PostgreSQL Cluster in CCE:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="umami-postgresql.yaml"',children:'apiVersion: acid.zalan.do/v1\nkind: postgresql\nmetadata:\n  labels:\n    application: umami\n  name: umami-psql\nspec:\n  databases:\n    umami: umami\n  numberOfInstances: 1\n  postgresql:\n    version: "16"\n    parameters:  \n      huge_pages: "false"\n  preparedDatabases:\n    umami:\n      defaultUsers: true\n      schemas:\n        data: {}\n        history:\n          defaultRoles: true\n          defaultUsers: false\n  resources:\n    limits:\n      cpu: 500m\n      memory: 500Mi\n    requests:\n      cpu: 10m\n      memory: 100Mi\n  teamId: default\n  users:\n    admin:\n      - superuser\n      - createdb\n    umami: []\n  volume:\n    size: 1Gi\n    storageClass: csi-disk\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f umami-postgresql.yaml\n"})}),"\n",(0,i.jsx)(n.h3,{id:"deploying-umami",children:"Deploying Umami"}),"\n",(0,i.jsx)(n.p,{children:"Create the follow manifest:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="umami-web-deployment.yaml"',children:"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: umami-web    \nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: umami-web\n  template:\n    metadata:\n      labels:\n        app: umami-web\n    spec:\n      containers:\n        - name: web\n          image: ghcr.io/umami-software/umami:postgresql-latest\n          ports:\n            - containerPort: 5000\n              protocol: TCP\n          env:\n            - name: PORT\n              value: '5000'\n            - name: DB_DATABASE\n              value: \"umami\"\n            - name: DB_HOST\n              value: umami-psql.docs-next.svc.cluster.local\n            - name: DB_PORT\n              value: '5432'\n            - name: DB_USERNAME\n              valueFrom:\n                secretKeyRef:\n                  name: umami.umami-psql.credentials.postgresql.acid.zalan.do\n                  key: username\n            - name: DB_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  name: umami.umami-psql.credentials.postgresql.acid.zalan.do\n                  key: password\n            - name: DATABASE_URL\n              value: \"postgres://$(DB_USERNAME):$(DB_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(DB_DATABASE)\"\n          imagePullPolicy: IfNotPresent\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f umami-web-deployment.yaml\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"important",children:(0,i.jsxs)(n.p,{children:["A Kubernetes Secret with the name ",(0,i.jsx)(n.code,{children:"umami.umami-psql.credentials.postgresql.acid.zalan.do"}),", containing the credentials of the ",(0,i.jsx)(n.code,{children:"umami"})," database, will be automatically provisioned by the zalando-postgres-operator during the application of manifest ",(0,i.jsx)(n.strong,{children:"umami-postgresql.yaml"}),". The environmental variables ",(0,i.jsx)(n.code,{children:"DB_USERNAME"})," & ",(0,i.jsx)(n.code,{children:"DB_PASSWORD"})," are getting their values by referencing this Secret."]})}),"\n",(0,i.jsx)(n.h2,{id:"creating-an-elastic-load-balancer",children:"Creating an Elastic Load Balancer"}),"\n",(0,i.jsxs)(n.p,{children:["Navigate to ",(0,i.jsx)(n.em,{children:"Network Console"}),"->",(0,i.jsx)(n.em,{children:"Elastic Load Balancing"})," and click ",(0,i.jsx)(n.em,{children:"Create Elastic Load Balancer"}),". Choose to create ",(0,i.jsx)(n.em,{children:"Shared Load Balancer"})," and choose ",(0,i.jsx)(n.em,{children:"New EIP"})," so the new ELB is automatically bound to a new elastic IP:"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://arch-assets-dev.obs.eu-de.otc.t-systems.com/static/img/docs/blueprints/by-use-case/analytics/umami/Screenshot%20from%202024-09-10%2014-32-38.png",alt:"alt text"})}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:"Write down the ID of the Elastic Load Balancer we are going to need it in the next steps."})}),"\n",(0,i.jsx)(n.h2,{id:"exposing-umami",children:"Exposing Umami"}),"\n",(0,i.jsx)(n.h3,{id:"creating-a-service",children:"Creating a Service"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="umami-service.yaml"',children:"apiVersion: v1\nkind: Service\nmetadata:\n  name: umami-web\nspec:\n  type: NodePort\n  ports:\n    - protocol: TCP\n      name: umami\n      port: 5000\n      targetPort: 5000\n  selector:\n    app: umami-web\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f umami-service.yaml\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["If you are ",(0,i.jsx)(n.strong,{children:"not"})," planning to expose the service via an ",(0,i.jsx)(n.code,{children:"Ingress"})," object, change the ",(0,i.jsx)(n.strong,{children:"type"})," to ",(0,i.jsx)(n.code,{children:"ClusterIP"}),"."]})}),"\n",(0,i.jsx)(n.h3,{id:"creating-an-ingress-optional",children:"Creating an Ingress (optional)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="umami-ingress.yaml"',children:"apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: umami-ingress\n  labels:\n    app: umami-web\n  annotations:\n    kubernetes.io/elb.class: union\n    kubernetes.io/elb.id: {value}\n    kubernetes.io/elb.port: 80\nspec:\n  ingressClassName: cce\n  rules:\n  - host: umami.example.com\n    http:\n      paths:\n      - backend:\n          service:\n            name: umami-web\n            port:\n              number: 5000\n        path: /\n        pathType: ImplementationSpecific\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"important",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Replace the placeholder ",(0,i.jsx)(n.code,{children:"{value}"})," of annotation ",(0,i.jsx)(n.strong,{children:"kubernetes.io/elb.id"})," with the ID of the Elastic Load Balancer we created before."]}),"\n",(0,i.jsxs)(n.li,{children:["If the Elastic Load Balancer you created was a shared one then the annotation ",(0,i.jsx)(n.strong,{children:"kubernetes.io/elb.class"})," should have the value ",(0,i.jsx)(n.code,{children:"union"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Replace ",(0,i.jsx)(n.code,{children:"umami.example.com"})," in ",(0,i.jsx)(n.strong,{children:"host"}),", with the FQDN of yours."]}),"\n"]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f umami-ingress.yaml\n"})}),"\n",(0,i.jsx)(n.h2,{id:"verification",children:"Verification"}),"\n",(0,i.jsxs)(n.p,{children:["Open in a browser the address: ",(0,i.jsx)(n.code,{children:"http://ELB_EIP"})," and you should now land at the logon page of Umami:"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://arch-assets-dev.obs.eu-de.otc.t-systems.com/static/img/docs/blueprints/by-use-case/analytics/umami/Screenshot%20from%202024-09-10%2015-05-13.png",alt:"alt text"})}),"\n",(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsxs)(n.p,{children:["Umami uses ",(0,i.jsx)(n.code,{children:"admin"}),"/",(0,i.jsx)(n.code,{children:"umami"})," as default credentials. ",(0,i.jsx)(n.strong,{children:"Change them immediatelly after you log in!"})]})})]})}function d(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(m,{...e})}):m(e)}},28453:(e,n,a)=>{a.d(n,{R:()=>r,x:()=>l});var s=a(96540);const i={},t=s.createContext(i);function r(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);