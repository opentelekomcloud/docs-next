"use strict";(self.webpackChunkdocs_next=self.webpackChunkdocs_next||[]).push([[1952],{76675:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"best-practices/containers/cloud-container-engine/auto-scaling-based-on-elb-monitoring-metrics/auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter","title":"Auto Scaling Based on ELB Monitoring Metrics with Prometheus Adapter","description":"This article demonstrates how to implement auto scaling using the Prometheus Adapter with ELB monitoring metrics, enabling HPA to consume custom metrics from Prometheus.","source":"@site/docs/best-practices/containers/cloud-container-engine/auto-scaling-based-on-elb-monitoring-metrics/auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter.md","sourceDirName":"best-practices/containers/cloud-container-engine/auto-scaling-based-on-elb-monitoring-metrics","slug":"/best-practices/containers/cloud-container-engine/auto-scaling-based-on-elb-monitoring-metrics/auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter","permalink":"/docs-next/pr-preview/pr-322/docs/best-practices/containers/cloud-container-engine/auto-scaling-based-on-elb-monitoring-metrics/auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter","draft":false,"unlisted":false,"editUrl":"https://github.com/opentelekomcloud/docs-next/tree/main/docs/best-practices/containers/cloud-container-engine/auto-scaling-based-on-elb-monitoring-metrics/auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter.md","tags":[{"inline":true,"label":"cce","permalink":"/docs-next/pr-preview/pr-322/docs/tags/cce"},{"inline":true,"label":"elb","permalink":"/docs-next/pr-preview/pr-322/docs/tags/elb"},{"inline":true,"label":"hpa","permalink":"/docs-next/pr-preview/pr-322/docs/tags/hpa"},{"inline":true,"label":"prometheus","permalink":"/docs-next/pr-preview/pr-322/docs/tags/prometheus"},{"inline":true,"label":"prometheus-adapter","permalink":"/docs-next/pr-preview/pr-322/docs/tags/prometheus-adapter"},{"inline":true,"label":"cloudeye","permalink":"/docs-next/pr-preview/pr-322/docs/tags/cloudeye"}],"version":"current","frontMatter":{"id":"auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter","title":"Auto Scaling Based on ELB Monitoring Metrics with Prometheus Adapter","tags":["cce","elb","hpa","prometheus","prometheus-adapter","cloudeye"]},"sidebar":"bestPracticesSidebar","previous":{"title":"Auto Scaling Based on ELB Monitoring Metrics with KEDA","permalink":"/docs-next/pr-preview/pr-322/docs/best-practices/containers/cloud-container-engine/auto-scaling-based-on-elb-monitoring-metrics/auto-scaling-based-on-elb-monitoring-metrics-with-keda"},"next":{"title":"Migrating Clusters from Other Clouds to CCE","permalink":"/docs-next/pr-preview/pr-322/docs/best-practices/containers/cloud-container-engine/migrating-from-other_clouds-to-cce"}}');var r=n(74848),s=n(28453);const o={id:"auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter",title:"Auto Scaling Based on ELB Monitoring Metrics with Prometheus Adapter",tags:["cce","elb","hpa","prometheus","prometheus-adapter","cloudeye"]},a="Auto Scaling Based on ELB Monitoring Metrics with Prometheus Adapter",c={},l=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Solution Design",id:"solution-design",level:2},{value:"Installing prometheus-adapter",id:"installing-prometheus-adapter",level:2},{value:"Creating an HPA Policy",id:"creating-an-hpa-policy",level:2}];function d(e){const t={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter",children:"Auto Scaling Based on ELB Monitoring Metrics with Prometheus Adapter"})}),"\n",(0,r.jsx)(t.p,{children:"This article demonstrates how to implement auto scaling using the Prometheus Adapter with ELB monitoring metrics, enabling HPA to consume custom metrics from Prometheus."}),"\n",(0,r.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(t.p,{children:["Before following this guide, ensure you have completed the environment setup as described ",(0,r.jsx)(t.a,{href:"/docs-next/pr-preview/pr-322/docs/best-practices/containers/cloud-container-engine/auto-scaling-based-on-elb-monitoring-metrics/",children:"here"}),"."]}),"\n",(0,r.jsx)(t.p,{children:"Additionally, you need:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"Basic understanding of Kubernetes HPA (Horizontal Pod Autoscaler)"}),"\n",(0,r.jsx)(t.li,{children:"Familiarity with Prometheus metrics and queries"}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"solution-design",children:"Solution Design"}),"\n",(0,r.jsx)(t.p,{children:"This section describes an auto scaling solution based on ELB monitoring metrics."}),"\n",(0,r.jsx)(t.p,{children:"The key of this solution is to convert the data that is obtained from the ELB metric and exported to the Prometheus to the metric data that can be identified by HPA, and then perform auto scaling based on the converted data."}),"\n",(0,r.jsx)(t.p,{children:"The implementation scheme is as follows:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"Convert the Prometheus data into the Kubernetes metric API for the HPA controller to use"}),"\n",(0,r.jsx)(t.li,{children:"Set an HPA rule to use ELB monitoring data as auto scaling metrics"}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Figure 1 ELB traffic flows and monitoring\ndata",src:n(59491).A+"",width:"2680",height:"1594"})}),"\n",(0,r.jsx)(t.h2,{id:"installing-prometheus-adapter",children:"Installing prometheus-adapter"}),"\n",(0,r.jsxs)(t.p,{children:["Next, and last step, of the installation sequence is the deployment of ",(0,r.jsx)(t.strong,{children:"prometheus-adapter"})," that will give an additional custom metrics api endpoint that will bind our custom ",(0,r.jsx)(t.strong,{children:"CloudEye"})," metrics with ",(0,r.jsx)(t.strong,{children:"HPA"})," ",(0,r.jsx)(t.strong,{children:"./install-adapter.sh"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"envsubst < prometheus-adapter/override.tpl  prometheus-adapter/override.yaml\nsleep 15\n\nhelm repo add prometheus-community https://prometheus-community.github.io/helm-charts\nhelm repo update\n\nhelm upgrade --install --values prometheus-adapter/override.yaml prometheus-adapter prometheus-community/prometheus-adapter -n monitoring\n"})}),"\n",(0,r.jsxs)(t.p,{children:["The configuration values used for the prometheus-adapter chart will be autogenerated at ",(0,r.jsx)(t.strong,{children:"deploy/manifests/prometheus-adapter/override.yaml"}),". You could diff them with the default values ",(0,r.jsx)(t.strong,{children:"default.yaml"})," to figure out the changes."]}),"\n",(0,r.jsx)(t.h2,{id:"creating-an-hpa-policy",children:"Creating an HPA Policy"}),"\n",(0,r.jsx)(t.p,{children:"After the data reported by the exporter to Prometheus is converted into the Kubernetes metric API by using the Prometheus adapter, you can create an HPA policy for auto scaling."}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsxs)(t.p,{children:["Create an HPA policy. The inbound traffic of the ELB load balancer is used to trigger scale-out. When the value of ",(0,r.jsx)(t.code,{children:"m7_in_Bps"})," (inbound traffic rate) exceeds ",(0,r.jsx)(t.code,{children:"1000"}),", the nginx Deployment will be scaled."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"apiVersion: autoscaling/v2\nkind: HorizontalPodAutoscaler\nmetadata:\n  name: nginx\n  namespace: default\nspec:\n  scaleTargetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: nginx\n  minReplicas: 1\n  maxReplicas: 10\n  metrics:\n    - type: Object\n      object:\n        metric:\n          name: elb01_listener_m7_in_Bps\n        describedObject:\n          apiVersion: v1\n          kind: Service\n          name: cloudeye-exporter\n        target:\n          type: Value\n          value: 1000\n"})}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Figure 2 Created HPA Policy",src:n(5238).A+"",width:"2165",height:"391"})}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsx)(t.p,{children:"After the HPA policy is created, perform a pressure test on the\nworkload (accessing the pods through ELB). Then, the HPA controller\ndetermines whether scaling is required based on the configured\nvalue."}),"\n",(0,r.jsxs)(t.p,{children:["In the ",(0,r.jsx)(t.em,{children:"Events"})," dialog box, obtain scaling records in the ",(0,r.jsx)(t.em,{children:"Kubernetes Event"})," column."]}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Figure 3 Scaling events",src:n(69421).A+"",width:"1339",height:"511"})}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},59491:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/en-us_image_0000001160642449-2c86ff97112c5a6e54850807f5c15d5d.png"},69421:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/en-us_image_0000001606845825-2fc64d535bb9bfd1030c7b034f7f2a99.png"},5238:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/en-us_image_0000001606847653-fa31af0c30cd700e2fee1dca63f50408.png"},28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>a});var i=n(96540);const r={},s=i.createContext(r);function o(e){const t=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(s.Provider,{value:t},e.children)}}}]);