"use strict";(self.webpackChunkdocs_next=self.webpackChunkdocs_next||[]).push([[1952],{41521:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"best-practices/containers/cloud-container-engine/auto-scaling-based-on-elb-monitoring-metrics/auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter","title":"Auto Scaling Based on ELB Monitoring Metrics with Prometheus Adapter","description":"This article explains how to implement auto scaling with the Prometheus Adapter using ELB monitoring metrics, allowing the Horizontal Pod Autoscaler (HPA) to use custom metrics sourced from Prometheus.","source":"@site/docs/best-practices/containers/cloud-container-engine/auto-scaling-based-on-elb-monitoring-metrics/auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter.md","sourceDirName":"best-practices/containers/cloud-container-engine/auto-scaling-based-on-elb-monitoring-metrics","slug":"/best-practices/containers/cloud-container-engine/auto-scaling-based-on-elb-monitoring-metrics/auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter","permalink":"/docs-next/pr-preview/pr-335/docs/best-practices/containers/cloud-container-engine/auto-scaling-based-on-elb-monitoring-metrics/auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter","draft":false,"unlisted":false,"editUrl":"https://github.com/opentelekomcloud/docs-next/tree/main/docs/best-practices/containers/cloud-container-engine/auto-scaling-based-on-elb-monitoring-metrics/auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter.md","tags":[{"inline":true,"label":"cce","permalink":"/docs-next/pr-preview/pr-335/docs/tags/cce"},{"inline":true,"label":"elb","permalink":"/docs-next/pr-preview/pr-335/docs/tags/elb"},{"inline":true,"label":"hpa","permalink":"/docs-next/pr-preview/pr-335/docs/tags/hpa"},{"inline":true,"label":"prometheus","permalink":"/docs-next/pr-preview/pr-335/docs/tags/prometheus"},{"inline":true,"label":"prometheus-adapter","permalink":"/docs-next/pr-preview/pr-335/docs/tags/prometheus-adapter"},{"inline":true,"label":"cloudeye","permalink":"/docs-next/pr-preview/pr-335/docs/tags/cloudeye"}],"version":"current","frontMatter":{"id":"auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter","title":"Auto Scaling Based on ELB Monitoring Metrics with Prometheus Adapter","tags":["cce","elb","hpa","prometheus","prometheus-adapter","cloudeye"]},"sidebar":"bestPracticesSidebar","previous":{"title":"Auto Scaling Based on ELB Monitoring Metrics with KEDA","permalink":"/docs-next/pr-preview/pr-335/docs/best-practices/containers/cloud-container-engine/auto-scaling-based-on-elb-monitoring-metrics/auto-scaling-based-on-elb-monitoring-metrics-with-keda"},"next":{"title":"Migrating Clusters from Other Clouds to CCE","permalink":"/docs-next/pr-preview/pr-335/docs/best-practices/containers/cloud-container-engine/migrating-from-other_clouds-to-cce"}}');var o=n(74848),r=n(28453);const s={id:"auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter",title:"Auto Scaling Based on ELB Monitoring Metrics with Prometheus Adapter",tags:["cce","elb","hpa","prometheus","prometheus-adapter","cloudeye"]},a="Auto Scaling Based on ELB Monitoring Metrics with Prometheus Adapter",c={},l=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Solution Design",id:"solution-design",level:2},{value:"Installing a Prometheus Adapter",id:"installing-a-prometheus-adapter",level:2},{value:"Creating an HPA Policy",id:"creating-an-hpa-policy",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.header,{children:(0,o.jsx)(t.h1,{id:"auto-scaling-based-on-elb-monitoring-metrics-with-prometheus-adapter",children:"Auto Scaling Based on ELB Monitoring Metrics with Prometheus Adapter"})}),"\n",(0,o.jsx)(t.p,{children:"This article explains how to implement auto scaling with the Prometheus Adapter using ELB monitoring metrics, allowing the Horizontal Pod Autoscaler (HPA) to use custom metrics sourced from Prometheus."}),"\n",(0,o.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,o.jsxs)(t.p,{children:["Before proceeding with this guide, make sure you have completed the environment setup outlined in ",(0,o.jsx)(t.a,{href:"/docs-next/pr-preview/pr-335/docs/best-practices/containers/cloud-container-engine/auto-scaling-based-on-elb-monitoring-metrics/",children:"this section"}),". You should additionally have a basic understanding of the Kubernetes Horizontal Pod Autoscaler (HPA) and be familiar with Prometheus metrics and query syntax."]}),"\n",(0,o.jsx)(t.h2,{id:"solution-design",children:"Solution Design"}),"\n",(0,o.jsx)(t.p,{children:"This section outlines an auto scaling approach that leverages ELB monitoring metrics. The core idea is to take ELB metric data exposed to Prometheus, convert it into a format compatible with the Kubernetes Metrics API, and make it available for the Horizontal Pod Autoscaler (HPA) to consume. This allows scaling decisions to be driven directly by ELB traffic patterns rather than traditional CPU or memory usage."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Figure 1 ELB traffic flows and monitoring\ndata",src:n(59491).A+"",width:"2680",height:"1594"})}),"\n",(0,o.jsx)(t.p,{children:"The implementation involves two main steps: exposing the Prometheus metrics through the Kubernetes Metrics API using the Prometheus Adapter, and defining an HPA policy that references the ELB-based metrics for scaling."}),"\n",(0,o.jsx)(t.h2,{id:"installing-a-prometheus-adapter",children:"Installing a Prometheus Adapter"}),"\n",(0,o.jsxs)(t.p,{children:["The key step is deploying the ",(0,o.jsx)(t.strong,{children:"Prometheus Adapter"}),", which provides an additional Custom Metrics API endpoint. This component connects the Cloud Eye metrics exposed in Prometheus with the Kubernetes HPA. To deploy it, run the script ",(0,o.jsx)(t.code,{children:"./install-adapter.sh"}),"."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"envsubst < prometheus-adapter/override.tpl  prometheus-adapter/override.yaml\nsleep 15\n\nhelm repo add prometheus-community https://prometheus-community.github.io/helm-charts\nhelm repo update\n\nhelm upgrade --install prometheus-adapter prometheus-community/prometheus-adapter \\\n--values prometheus-adapter/override.yaml \\\n-n monitoring --create-namespace\n"})}),"\n",(0,o.jsx)(t.admonition,{type:"note",children:(0,o.jsxs)(t.p,{children:["The configuration values for the Prometheus Adapter Helm chart are automatically generated at ",(0,o.jsx)(t.code,{children:"deploy/manifests/prometheus-adapter/override.yaml"}),". You can compare this file with the default ",(0,o.jsx)(t.code,{children:"default.yaml"})," to review the applied modifications."]})}),"\n",(0,o.jsx)(t.h2,{id:"creating-an-hpa-policy",children:"Creating an HPA Policy"}),"\n",(0,o.jsx)(t.p,{children:"Once the Prometheus Adapter converts the exporter\u2019s data into the Kubernetes Metrics API format, you can define an HPA policy to enable automatic scaling based on those metrics."}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["Create an HPA policy. The inbound traffic of the ELB load balancer is used to trigger scale-out. When the value of ",(0,o.jsx)(t.code,{children:"m7_in_Bps"})," (inbound traffic rate) exceeds ",(0,o.jsx)(t.code,{children:"1000"}),", the nginx Deployment will be scaled."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-yaml",children:"apiVersion: autoscaling/v2\nkind: HorizontalPodAutoscaler\nmetadata:\n  name: nginx\n  namespace: default\nspec:\n  scaleTargetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: nginx\n  minReplicas: 1\n  maxReplicas: 10\n  metrics:\n    - type: Object\n      object:\n        metric:\n          name: elb01_listener_m7_in_Bps\n        describedObject:\n          apiVersion: v1\n          kind: Service\n          name: cloudeye-exporter\n        target:\n          type: Value\n          value: 1000\n"})}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Figure 2 Created HPA Policy",src:n(5238).A+"",width:"2165",height:"391"})}),"\n"]}),"\n",(0,o.jsxs)(t.li,{children:["\n",(0,o.jsxs)(t.p,{children:["After creating the HPA policy, run a load test on the workload by generating traffic through the ELB. The HPA controller will monitor the defined metrics and decide whether to scale the deployment based on the configured thresholds. In the ",(0,o.jsx)(t.strong,{children:"Events"})," view, check the ",(0,o.jsx)(t.strong,{children:"Kubernetes Event"})," column to review the recorded scaling activities:"]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.img,{alt:"Figure 3 Scaling events",src:n(69421).A+"",width:"1339",height:"511"})}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},59491:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/en-us_image_0000001160642449-2c86ff97112c5a6e54850807f5c15d5d.png"},69421:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/en-us_image_0000001606845825-2fc64d535bb9bfd1030c7b034f7f2a99.png"},5238:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/en-us_image_0000001606847653-fa31af0c30cd700e2fee1dca63f50408.png"},28453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>a});var i=n(96540);const o={},r=i.createContext(o);function s(e){const t=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),i.createElement(r.Provider,{value:t},e.children)}}}]);