"use strict";(self.webpackChunkdocs_next=self.webpackChunkdocs_next||[]).push([[36588],{73026:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>p,frontMatter:()=>o,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"best-practices/containers/cloud-container-engine/restore-kubernetes-objects","title":"Restoring Kubernetes Objects in a CCE Cluster","description":"In this part of the guide, we will demonstrate how to restore a WordPress backup created with Velero (FSB) onto a target Open Telekom Cloud CCE cluster. The process includes restoring both the namespace resources (Deployments, Services, Secrets, ConfigMaps) and the persistent volumes for MySQL and WordPress content, effectively migrating the workload into a new cluster.","source":"@site/docs/best-practices/containers/cloud-container-engine/restore-kubernetes-objects.md","sourceDirName":"best-practices/containers/cloud-container-engine","slug":"/best-practices/containers/cloud-container-engine/restore-kubernetes-objects","permalink":"/docs-next/pr-preview/pr-338/docs/best-practices/containers/cloud-container-engine/restore-kubernetes-objects","draft":false,"unlisted":false,"editUrl":"https://github.com/opentelekomcloud/docs-next/tree/main/docs/best-practices/containers/cloud-container-engine/restore-kubernetes-objects.md","tags":[{"inline":true,"label":"cce","permalink":"/docs-next/pr-preview/pr-338/docs/tags/cce"},{"inline":true,"label":"migration","permalink":"/docs-next/pr-preview/pr-338/docs/tags/migration"},{"inline":true,"label":"minio","permalink":"/docs-next/pr-preview/pr-338/docs/tags/minio"},{"inline":true,"label":"velero","permalink":"/docs-next/pr-preview/pr-338/docs/tags/velero"},{"inline":true,"label":"obs","permalink":"/docs-next/pr-preview/pr-338/docs/tags/obs"},{"inline":true,"label":"wordpress","permalink":"/docs-next/pr-preview/pr-338/docs/tags/wordpress"},{"inline":true,"label":"kubernetes","permalink":"/docs-next/pr-preview/pr-338/docs/tags/kubernetes"},{"inline":true,"label":"aws","permalink":"/docs-next/pr-preview/pr-338/docs/tags/aws"},{"inline":true,"label":"eks","permalink":"/docs-next/pr-preview/pr-338/docs/tags/eks"}],"version":"current","frontMatter":{"id":"restore-kubernetes-objects","title":"Restoring Kubernetes Objects in a CCE Cluster","tags":["cce","migration","minio","velero","obs","wordpress","kubernetes","aws","eks"]},"sidebar":"bestPracticesSidebar","previous":{"title":"Backing Up Kubernetes Objects of other Clusters","permalink":"/docs-next/pr-preview/pr-338/docs/best-practices/containers/cloud-container-engine/backup-kubernetes-objects"},"next":{"title":"Cloud Container Instance","permalink":"/docs-next/pr-preview/pr-338/docs/best-practices/containers/cloud-container-instance"}}');var r=s(74848),i=s(28453);const o={id:"restore-kubernetes-objects",title:"Restoring Kubernetes Objects in a CCE Cluster",tags:["cce","migration","minio","velero","obs","wordpress","kubernetes","aws","eks"]},a="Restoring Kubernetes Objects in a CCE Cluster",c={},l=[{value:"Creating StorageClass Mappings",id:"creating-storageclass-mappings",level:2},{value:"Option 1: Creating a ConfigMap Mapping",id:"option-1-creating-a-configmap-mapping",level:3},{value:"Option 2: Creating a new StorageClass",id:"option-2-creating-a-new-storageclass",level:3},{value:"Restoring the Application",id:"restoring-the-application",level:2},{value:"Post-Migration Considerations",id:"post-migration-considerations",level:2},{value:"Updating Images",id:"updating-images",level:3},{value:"Updating Services",id:"updating-services",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"restoring-kubernetes-objects-in-a-cce-cluster",children:"Restoring Kubernetes Objects in a CCE Cluster"})}),"\n",(0,r.jsx)(n.p,{children:"In this part of the guide, we will demonstrate how to restore a WordPress backup created with Velero (FSB) onto a target Open Telekom Cloud CCE cluster. The process includes restoring both the namespace resources (Deployments, Services, Secrets, ConfigMaps) and the persistent volumes for MySQL and WordPress content, effectively migrating the workload into a new cluster."}),"\n",(0,r.jsx)(n.admonition,{type:"important",children:(0,r.jsx)(n.p,{children:"The following actions have to be performed on the Open Telekom Cloud CCE cluster which is our migration target."})}),"\n",(0,r.jsx)(n.h2,{id:"creating-storageclass-mappings",children:"Creating StorageClass Mappings"}),"\n",(0,r.jsx)(n.p,{children:"Since/If storage infrastructures differ between clusters, volumes cannot be mounted on the target cluster without adjustment. To address this, you must create a mapping between the source and target storage classes."}),"\n",(0,r.jsxs)(n.p,{children:["Hence, you need to create a ",(0,r.jsx)(n.code,{children:"StorageClass"})," in Open Telekom Cloud CCE ",(0,r.jsx)(n.strong,{children:"with the exact same name"})," as the one used in the source cloud provider, in this case AWS. In this case SSDs, as backend storage media, will be mapped to a new ",(0,r.jsx)(n.code,{children:"StorageClass"})," that has the same name, namely ",(0,r.jsx)(n.code,{children:"gp2"}),", as their equivalent in AWS."]}),"\n",(0,r.jsx)(n.admonition,{type:"important",children:(0,r.jsxs)(n.p,{children:["Choose one of the two methods described below, and apply it ",(0,r.jsx)(n.strong,{children:"before"})," restoring the application in the target cluster. If no matching StorageClass exists at the target and the mapping is not configured in advance, persistent volumes will fail to restore."]})}),"\n",(0,r.jsx)(n.h3,{id:"option-1-creating-a-configmap-mapping",children:"Option 1: Creating a ConfigMap Mapping"}),"\n",(0,r.jsxs)(n.p,{children:["Create a ",(0,r.jsx)(n.code,{children:"ConfigMap"}),", named ",(0,r.jsx)(n.strong,{children:"storageclasses-remapping.yaml"}),", in your workstation:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: storageclasses-remapping\n  namespace: velero\n  labels:\n    app.kubernetes.io/name: velero\n    velero.io/plugin-config: "true"\n    velero.io/change-storage-class: RestoreItemAction\ndata:\n  gp2: csi-disk\n'})}),"\n",(0,r.jsx)(n.p,{children:"and then apply it:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f storageclasses-remapping.yaml\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:["With this option, you can remap multiple storage classes at once. Each key/value pair in the ",(0,r.jsx)(n.code,{children:"data"})," section must follow the format ",(0,r.jsx)(n.code,{children:"STORAGECLASS_IN_SOURCE:STORAGECLASS_IN_TARGET"}),"."]})}),"\n",(0,r.jsx)(n.h3,{id:"option-2-creating-a-new-storageclass",children:"Option 2: Creating a new StorageClass"}),"\n",(0,r.jsxs)(n.p,{children:["Prepare the manifest for the new ",(0,r.jsx)(n.code,{children:"StorageClass"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="cce-storageclass-gp2.yaml"',children:'apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: gp2\n  selfLink: /apis/storage.k8s.io/v1/storageclasses/csi-disk\nparameters:\n  csi.storage.k8s.io/csi-driver-name: disk.csi.everest.io\n  csi.storage.k8s.io/fstype: ext4\n  everest.io/disk-volume-type: SSD\n  everest.io/passthrough: "true"\nprovisioner: everest-csi-provisioner\nreclaimPolicy: Delete\nvolumeBindingMode: Immediate\nallowVolumeExpansion: true\n'})}),"\n",(0,r.jsx)(n.p,{children:"and then apply it:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kubectl create -f cce-storageclass-gp2.yaml\n"})}),"\n",(0,r.jsx)(n.h2,{id:"restoring-the-application",children:"Restoring the Application"}),"\n",(0,r.jsx)(n.p,{children:"Then we can proceed restoring the backup:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"velero restore create wp-restore \\\n  --from-backup wp-backup-auto \\\n  --namespace-mappings wordpress:wordpress \n"})}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["If you want to restore the application into a different namespace, adjust the second value of the ",(0,r.jsx)(n.code,{children:"--namespace-mappings"}),", for example: ",(0,r.jsx)(n.code,{children:"--namespace-mappings wordpress:wordpress-restored"}),"."]})}),"\n",(0,r.jsx)(n.p,{children:"In order to verify the status of the restore we could execute the following commands:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"velero restore get\nvelero restore describe wp-restore\n"})}),"\n",(0,r.jsx)(n.p,{children:"or simply follow the progress of the restore directly from the WebUI, we previously installed:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"image1",src:s(34168).A+"",width:"1913",height:"872"})}),"\n",(0,r.jsx)(n.h2,{id:"post-migration-considerations",children:"Post-Migration Considerations"}),"\n",(0,r.jsx)(n.h3,{id:"updating-images",children:"Updating Images"}),"\n",(0,r.jsx)(n.admonition,{type:"important",children:(0,r.jsx)(n.p,{children:"You can skip this section if you have decided not to use SWR as part of your setup. The steps described here are only relevant when container images need to be migrated into or managed through the Software Repository for Containers."})}),"\n",(0,r.jsxs)(n.p,{children:["If your container images (for MySQL and WordPress) are already located in SWR, an image pull failure (",(0,r.jsx)(n.code,{children:"ErrImagePull"}),") will not occur. If the application to be migrated is created from a private image, perform the following steps to update the image:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Migrate the image resources to SWR. For details, see ",(0,r.jsx)(n.a,{href:"https://docs.otc.t-systems.com/usermanual/swr/swr_01_0011.html",children:"Uploading an Image Through the Client"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Log in to the SWR console and obtain the image path used after the migration. The image path will be in the following format: ",(0,r.jsx)(n.code,{children:"swr.{REGION}.otc.t-systems.com/{ORGANIZATION_NAME}/{IMAGE_NAME}:{IMAGE_TAG}"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Run the following command to modify the workload and replace the ",(0,r.jsx)(n.code,{children:"image"})," stanza value in the manifest file with the image path you obtained in the previous step:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"kubectl edit deploy wordpress \n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"updating-services",children:"Updating Services"}),"\n",(0,r.jsxs)(n.p,{children:["After the cluster is migrated, the Service of the source cluster may fail to take effect. You can perform the following steps to update the Service. If ingresses are configured in the source cluster, connect the new cluster to ELB again after the migration. For details, see ",(0,r.jsx)(n.a,{href:"https://docs.otc.t-systems.com/en-us/usermanual2/cce/cce_10_0252.html",children:"Using kubectl to Create an ELB Ingress"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["Edit the manifest of the respective ",(0,r.jsx)(n.code,{children:"Service"})," to change its type and port number."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"kubectl edit svc wordpress\n"})}),"\n",(0,r.jsxs)(n.p,{children:["To modify load balancer resources, apply the required annotations by following the ",(0,r.jsx)(n.a,{href:"https://docs.otc.t-systems.com/cloud-container-engine/umn/network/service/loadbalancer/index.html",children:"instructions"})," outlined in the LoadBalancer configuration section, .e.g.:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"annotations:\n  kubernetes.io/elb.class: union \n  kubernetes.io/elb.id: 9d06a39d-xxxx-xxxx-xxxx-c204397498a3   \n  kubernetes.io/elb.subnet-id: f86ba71c-xxxx-xxxx-xxxx-39c8a7d4bb36    \n  kubernetes.io/session-affinity-mode: SOURCE_IP    \n"})})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},34168:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/Screenshot_from_2025-09-10_17-06-30-564c08601fd8da998aa1a3059fb4d649.png"},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>a});var t=s(96540);const r={},i=t.createContext(r);function o(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);