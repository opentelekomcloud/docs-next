"use strict";(self.webpackChunkdocs_next=self.webpackChunkdocs_next||[]).push([[243],{72321:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>l,contentTitle:()=>s,default:()=>g,frontMatter:()=>o,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"blueprints/by-use-case/observability/aggregate-cce-logs-with-promtail-and-grafana-loki","title":"Aggregate CCE Logs with Promtail & Grafana Loki","description":"This blueprint explains how to collect and centralize logs from Cloud Container Engine (CCE) using Promtail and Grafana Loki. It outlines the process of configuring Promtail as a log forwarder within Kubernetes and integrating it with Grafana Loki for efficient storage and visualization. By the end, you will have a unified and scalable logging setup that simplifies monitoring, troubleshooting, and operational insights across your CCE workloads.","source":"@site/docs/blueprints/by-use-case/observability/aggregate-cce-logs-with-promtail-and-grafana-loki.md","sourceDirName":"blueprints/by-use-case/observability","slug":"/blueprints/by-use-case/observability/aggregate-cce-logs-with-promtail-and-grafana-loki","permalink":"/docs-next/pr-preview/pr-347/docs/blueprints/by-use-case/observability/aggregate-cce-logs-with-promtail-and-grafana-loki","draft":false,"unlisted":false,"editUrl":"https://github.com/opentelekomcloud/docs-next/tree/main/docs/blueprints/by-use-case/observability/aggregate-cce-logs-with-promtail-and-grafana-loki.md","tags":[{"inline":true,"label":"cce","permalink":"/docs-next/pr-preview/pr-347/docs/tags/cce"},{"inline":true,"label":"observability","permalink":"/docs-next/pr-preview/pr-347/docs/tags/observability"},{"inline":true,"label":"logging","permalink":"/docs-next/pr-preview/pr-347/docs/tags/logging"},{"inline":true,"label":"grafana","permalink":"/docs-next/pr-preview/pr-347/docs/tags/grafana"},{"inline":true,"label":"loki","permalink":"/docs-next/pr-preview/pr-347/docs/tags/loki"},{"inline":true,"label":"promtail","permalink":"/docs-next/pr-preview/pr-347/docs/tags/promtail"}],"version":"current","sidebarPosition":2,"frontMatter":{"id":"aggregate-cce-logs-with-promtail-and-grafana-loki","title":"Aggregate CCE Logs with Promtail & Grafana Loki","tags":["cce","observability","logging","grafana","loki","promtail"],"sidebar_position":2},"sidebar":"blueprintsSidebar","previous":{"title":"Deploy Grafana Loki on CCE","permalink":"/docs-next/pr-preview/pr-347/docs/blueprints/by-use-case/observability/deploy-grafana-loki-on-cce"},"next":{"title":"Aggregate CCE Logs with Fluent Bit & Grafana Loki","permalink":"/docs-next/pr-preview/pr-347/docs/blueprints/by-use-case/observability/aggregate-cce-logs-with-fluentbit-and-grafana-loki"}}');var t=n(74848),r=n(28453);const o={id:"aggregate-cce-logs-with-promtail-and-grafana-loki",title:"Aggregate CCE Logs with Promtail & Grafana Loki",tags:["cce","observability","logging","grafana","loki","promtail"],sidebar_position:2},s="Aggregate CCE Logs with Promtail & Grafana Loki",l={},c=[{value:"Installing Grafana Loki",id:"installing-grafana-loki",level:2},{value:"Installing Promtail",id:"installing-promtail",level:2},{value:"Installing Grafana (Optional)",id:"installing-grafana-optional",level:2}];function d(e){const a={a:"a",admonition:"admonition",br:"br",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",img:"img",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(a.header,{children:(0,t.jsx)(a.h1,{id:"aggregate-cce-logs-with-promtail--grafana-loki",children:"Aggregate CCE Logs with Promtail & Grafana Loki"})}),"\n",(0,t.jsxs)(a.p,{children:["This blueprint explains how to collect and centralize logs from Cloud Container Engine (CCE) using ",(0,t.jsx)(a.a,{href:"https://grafana.com/docs/loki/latest/send-data/promtail/",children:"Promtail"})," and ",(0,t.jsx)(a.a,{href:"https://grafana.com/oss/loki/",children:"Grafana Loki"}),". It outlines the process of configuring Promtail as a log forwarder within Kubernetes and integrating it with Grafana Loki for efficient storage and visualization. By the end, you will have a unified and scalable logging setup that simplifies monitoring, troubleshooting, and operational insights across your CCE workloads."]}),"\n",(0,t.jsxs)(a.admonition,{title:"Disclaimer",type:"warning",children:[(0,t.jsxs)(a.p,{children:["Promtail has been officially deprecated and was transitioned into Long-Term Support (LTS) on February 13, 2025. The project continues to receive only essential security and critical bug fixes, with no new feature development. The LTS phase is planned to last approximately one year, ending on February 28, 2026, after which Promtail will enter its ",(0,t.jsx)(a.strong,{children:"End-of-Life (EOL) phase on March 2, 2026"}),". Once EOL is reached, maintenance, updates, and official support will cease entirely."]}),(0,t.jsxs)(a.p,{children:["All new feature development and enhancements have moved to ",(0,t.jsx)(a.a,{href:"https://grafana.com/docs/alloy/latest/",children:"Grafana Alloy"}),", which replaces Promtail as the actively maintained log collection agent."]}),(0,t.jsxs)(a.p,{children:["If you are using Promtail, we are strongly recommending you ",(0,t.jsx)(a.a,{href:"https://grafana.com/docs/loki/latest/setup/migrate/migrate-to-alloy/",children:"migrate to Alloy"})," or choose another forwarding solution, as Fluent-Bit that we already describe in another blueprint, ",(0,t.jsx)(a.a,{href:"/docs-next/pr-preview/pr-347/docs/blueprints/by-use-case/observability/aggregate-cce-logs-with-fluentbit-and-grafana-loki",children:"Aggregate CCE Logs with Fluent Bit & Grafana Loki"}),", how to integrate with Loki."]}),(0,t.jsxs)(a.p,{children:["If you are currently using Promtail, it is strongly recommended to ",(0,t.jsx)(a.a,{href:"https://grafana.com/docs/loki/latest/setup/migrate/migrate-to-alloy/",children:"migrate to Grafana Alloy"})," or adopt an alternative log forwarding solution such as Fluent Bit. The blueprint ",(0,t.jsx)(a.a,{href:"/docs-next/pr-preview/pr-347/docs/blueprints/by-use-case/observability/aggregate-cce-logs-with-fluentbit-and-grafana-loki",children:"Aggregate CCE Logs with Fluent Bit & Grafana Loki"})," provides detailed guidance on integrating Fluent Bit with Loki for a reliable and future-proof logging setup."]})]}),"\n",(0,t.jsx)(a.p,{children:"Grafana Loki serves as a log aggregation system optimized for scalability, availability, and cost efficiency. Drawing inspiration from Prometheus, Loki indexes only metadata through labels rather than the log content itself. It was introduced by Grafana Labs in 2018."}),"\n",(0,t.jsx)(a.p,{children:"Loki uses Promtail to aggregate logs. Promtail is a logs collector agent that collects, labels, and ships logs to Loki. It runs on each Kubernetes node, using the same service discovery as Prometheus and supporting similar methods for labeling, transforming, and filtering logs before their ingestion to Loki."}),"\n",(0,t.jsx)(a.p,{children:(0,t.jsx)(a.img,{alt:"image",src:n(44877).A+"",width:"931",height:"364"})}),"\n",(0,t.jsx)(a.p,{children:"Loki groups log entries into streams and indexes them with labels, which reduces overall costs and the time between log entry ingestion and query availability."}),"\n",(0,t.jsx)(a.h2,{id:"installing-grafana-loki",children:"Installing Grafana Loki"}),"\n",(0,t.jsxs)(a.p,{children:["If you don\u2019t already have a Grafana Loki instance running, you can set it up first before proceeding with log aggregation. The installation process is covered in detail in the companion blueprint ",(0,t.jsx)(a.a,{href:"/docs/blueprints/by-use-case/observability/deploy-grafana-loki-on-cce",children:"Deploy Grafana Loki on CCE"}),", which explains how to deploy Loki in microservices mode on Cloud Container Engine (CCE) with Open Telekom Cloud Object Storage (OBS) as the backend. Once Loki is up and running, you can continue here to install and configure Promtail and start collecting and centralizing logs from your CCE workloads."]}),"\n",(0,t.jsx)(a.h2,{id:"installing-promtail",children:"Installing Promtail"}),"\n",(0,t.jsxs)(a.p,{children:["Create a values file called ",(0,t.jsx)(a.strong,{children:"values-promtail.yaml"}),":"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-yaml",metastring:'title="values-promtail.yaml"',children:'daemonset:\n  enabled: true\n\nresources:\n  requests:\n    cpu: 100m\n    memory: 128Mi\n  limits:\n    cpu: 500m\n    memory: 256Mi\n\ntolerations:\n  - key: "node-role.kubernetes.io/control-plane"\n    operator: "Exists"\n    effect: "NoSchedule"\n  - key: "node-role.kubernetes.io/master"\n    operator: "Exists"\n    effect: "NoSchedule"\n\nconfig:\n  server:\n    http_listen_port: 3101\n    grpc_listen_port: 0\n\n  positions:\n    filename: /run/promtail/positions.yaml\n\n  clients:\n    - url: http://loki-gateway.monitoring.svc.cluster.local/loki/api/v1/push\n      batchwait: 1s\n      batchsize: 1048576\n      backoff_config:\n        min_period: 500ms\n        max_period: 5s\n        max_retries: 10\n      timeout: 10s\n\n  scrape_configs:\n    - job_name: kubernetes-pods\n      pipeline_stages:\n        - cri: {}\n        - json:\n            expressions:\n              msg: message | msg | log\n              level: level | severity\n              ts: ts | time | timestamp\n        - timestamp:\n            source: ts\n            format: RFC3339\n            action_on_failure: skip\n        - output:\n            source: msg\n        - labels:\n            level:\n      kubernetes_sd_configs:\n        - role: pod\n      relabel_configs:\n        - action: drop\n          source_labels: [__meta_kubernetes_pod_phase]\n          regex: (Succeeded|Failed)\n        - action: replace\n          source_labels: [__meta_kubernetes_namespace]\n          target_label: namespace\n        - action: replace\n          source_labels: [__meta_kubernetes_pod_name]\n          target_label: pod\n        - action: replace\n          source_labels: [__meta_kubernetes_pod_container_name]\n          target_label: container\n        - action: replace\n          source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]\n          target_label: app\n          regex: (.+)\n        - action: replace\n          source_labels: [__meta_kubernetes_pod_label_app]\n          target_label: app\n          regex: (.+)\n        - action: replace\n          target_label: node\n          replacement: ${HOSTNAME}\n        # containerd/docker symlinked pod log path\n        - action: replace\n          source_labels: [__meta_kubernetes_pod_uid]\n          target_label: __path__\n          replacement: /var/log/pods/*$1/*.log\n        - action: labeldrop\n          regex: (pod_template_hash|controller_revision_hash)\n\nrbac:\n  pspEnabled: false\n\nserviceMonitor:\n  enabled: false\n'})}),"\n",(0,t.jsx)(a.p,{children:"and deploy via Helm:"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-bash",children:"helm repo add grafana https://grafana.github.io/helm-charts\nhelm repo update\n\nhelm upgrade --install promtail grafana/promtail \\\n-f values-promtail.yaml \\\n-n monitoring --create-namespace \\\n--reset-values\n"})}),"\n",(0,t.jsx)(a.h2,{id:"installing-grafana-optional",children:"Installing Grafana (Optional)"}),"\n",(0,t.jsxs)(a.p,{children:["For verification, we\u2019ll install Grafana with Helm and include a simple demo dashboard to confirm that logs are reaching Loki. This lightweight setup is only for validation and smoke testing. For most production clusters, the recommended approach is to deploy the ",(0,t.jsx)(a.a,{href:"https://github.com/prometheus-community/helm-charts/blob/main/charts/kube-prometheus-stack/README.md",children:"kube-prometheus-stack"})," bundle, which provides Grafana together with Prometheus, Alertmanager, and curated dashboards, offering tighter integration and easier ongoing operations."]}),"\n",(0,t.jsxs)(a.p,{children:["Create a values file called ",(0,t.jsx)(a.strong,{children:"values-grafana.yaml"}),":"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-yaml",metastring:'title="values-promtail.yaml"',children:'adminUser: admin\n\npersistence:\n  enabled: true\n  size: 5Gi\n  accessModes:\n    - ReadWriteOnce\n  storageClassName: "csi-disk"\n\nservice:\n  enabled: true\n  type: ClusterIP\n  port: 80\n\nresources:\n  requests:\n    cpu: 100m\n    memory: 256Mi\n  limits:\n    cpu: 500m\n    memory: 512Mi\n\ndatasources:\n  datasources.yaml:\n    apiVersion: 1\n    datasources:\n      - name: Loki\n        type: loki\n        access: proxy\n        url: http://loki-gateway.monitoring.svc.cluster.local\n        jsonData:\n          maxLines: 1000\n          derivedFields:\n            - datasourceUid: Loki\n              matcherRegex: "traceID=(\\\\w+)"\n              name: TraceID\n              url: "$${__value.raw}"\n        isDefault: true\n        editable: true\n\ndashboardProviders:\n  dashboardproviders.yaml:\n    apiVersion: 1\n    providers:\n      - name: \'default\'\n        orgId: 1\n        folder: \'\'\n        type: file\n        disableDeletion: false\n        editable: true\n        options:\n          path: /var/lib/grafana/dashboards/default\n\ndashboards:\n  default:\n    loki-logs:\n      gnetId: 15141\n      revision: 1\n      datasource: Loki\n\ngrafana.ini:\n  server:\n    root_url: "%(protocol)s://%(domain)s:%(http_port)s/"\n  analytics:\n    check_for_updates: true\n    check_for_plugin_updates: true\n  log:\n    mode: console\n  paths:\n    data: /var/lib/grafana/\n    logs: /var/log/grafana\n    plugins: /var/lib/grafana/plugins\n    provisioning: /etc/grafana/provisioning\n\nsecurityContext:\n  runAsNonRoot: true\n  runAsUser: 472\n  runAsGroup: 472\n  fsGroup: 472\n  allowPrivilegeEscalation: false\n  capabilities:\n    drop:\n      - ALL\n\nserviceMonitor:\n  enabled: false\n\nrbac:\n  create: true\n  pspEnabled: false\n\nserviceAccount:\n  create: true\n  autoMount: true\n'})}),"\n",(0,t.jsx)(a.p,{children:"and deploy via Helm:"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-bash",children:'helm repo add grafana https://grafana.github.io/helm-charts\nhelm repo update\n\nhelm upgrade --install grafana grafana/grafana \\\n-f values-grafana.yaml \\\n-n monitoring --create-namespace \\\n--set "adminPassword=$(openssl rand -base64 24)" \\\n--reset values\n'})}),"\n",(0,t.jsxs)(a.p,{children:["Go to ",(0,t.jsx)(a.em,{children:"Grafana"})," -> ",(0,t.jsx)(a.em,{children:"Dashboards"})," and click the dashboard we provisioned as bundle with the Helm Chart ",(0,t.jsx)(a.em,{children:"Loki Kubernetes Logs"}),":"]}),"\n",(0,t.jsx)(a.p,{children:(0,t.jsx)(a.img,{alt:"image",src:n(51400).A+"",width:"1914",height:"887"})}),"\n",(0,t.jsx)(a.admonition,{type:"note",children:(0,t.jsxs)(a.p,{children:["\ud83d\udca1"," The Grafana admin password can be found in ",(0,t.jsx)(a.code,{children:"grafana"})," secret in monitoring namespace.",(0,t.jsx)(a.br,{}),"\n","\u26a0\ufe0f"," This Grafana installation and the provided ",(0,t.jsx)(a.a,{href:"https://grafana.com/grafana/dashboards/15141-kubernetes-service-logs/",children:"dashboard"})," are intended for demonstration purposes only."]})})]})}function g(e={}){const{wrapper:a}={...(0,r.R)(),...e.components};return a?(0,t.jsx)(a,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},44877:(e,a,n)=>{n.d(a,{A:()=>i});const i=n.p+"assets/images/1_x7vfbTFPrJDX9n99xuigmw-bfad1fc6310e353a1107dbecf4a40269.webp"},51400:(e,a,n)=>{n.d(a,{A:()=>i});const i=n.p+"assets/images/Screenshot_from_2025-10-09_11-09-06-fd5a4ce07b2ef9ed386965344ba2557d.png"},28453:(e,a,n)=>{n.d(a,{R:()=>o,x:()=>s});var i=n(96540);const t={},r=i.createContext(t);function o(e){const a=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function s(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),i.createElement(r.Provider,{value:a},e.children)}}}]);