"use strict";(self.webpackChunkdocs_next=self.webpackChunkdocs_next||[]).push([[12087],{48767:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"blueprints/by-use-case/security/keycloak/cce-keycloak","title":"Deploy Keycloak on CCE","description":"This blueprint explains how to deploy Keycloak on a Cloud Container Engine (CCE) using an RDS PostgreSQL database for the supporting stateful storage. It guides through creating appropriate security groups, provisioning the database, and establishing DNS zones and endpoints. It covers all the necessary steps from provisioning the CCE cluster, deploying Keycloak secrets, application and services and exposing it externally using an ingress.","source":"@site/docs/blueprints/by-use-case/security/keycloak/cce-keycloak.md","sourceDirName":"blueprints/by-use-case/security/keycloak","slug":"/blueprints/by-use-case/security/keycloak/cce-keycloak","permalink":"/docs-next/pr-preview/pr-359/docs/blueprints/by-use-case/security/keycloak/cce-keycloak","draft":false,"unlisted":false,"editUrl":"https://github.com/opentelekomcloud/docs-next/tree/main/docs/blueprints/by-use-case/security/keycloak/cce-keycloak.md","tags":[{"inline":true,"label":"cce","permalink":"/docs-next/pr-preview/pr-359/docs/tags/cce"},{"inline":true,"label":"keycloak","permalink":"/docs-next/pr-preview/pr-359/docs/tags/keycloak"},{"inline":true,"label":"security","permalink":"/docs-next/pr-preview/pr-359/docs/tags/security"},{"inline":true,"label":"iam","permalink":"/docs-next/pr-preview/pr-359/docs/tags/iam"}],"version":"current","frontMatter":{"id":"cce-keycloak","title":"Deploy Keycloak on CCE","tags":["cce","keycloak","security","iam"]},"sidebar":"blueprintsSidebar","previous":{"title":"Keycloak","permalink":"/docs-next/pr-preview/pr-359/docs/blueprints/by-use-case/security/keycloak/keycloak"},"next":{"title":"Identity Federation with GitHub","permalink":"/docs-next/pr-preview/pr-359/docs/blueprints/by-use-case/security/keycloak/identity-federation-github"}}');var t=a(74848),i=a(28453);const o={id:"cce-keycloak",title:"Deploy Keycloak on CCE",tags:["cce","keycloak","security","iam"]},r="Deploy Keycloak on CCE",l={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Deploying a PostgreSQL with RDS",id:"deploying-a-postgresql-with-rds",level:2},{value:"Creating a Private DNS Zone",id:"creating-a-private-dns-zone",level:3},{value:"Provisioning a Database",id:"provisioning-a-database",level:3},{value:"Provisioning a CCE Cluster",id:"provisioning-a-cce-cluster",level:2},{value:"Deploying Keycloak",id:"deploying-keycloak",level:2},{value:"Deploying Secrets",id:"deploying-secrets",level:3},{value:"Deploying Application",id:"deploying-application",level:3},{value:"Deploying Ingress",id:"deploying-ingress",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Drop Database",id:"drop-database",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"deploy-keycloak-on-cce",children:"Deploy Keycloak on CCE"})}),"\n",(0,t.jsxs)(n.p,{children:["This blueprint explains how to deploy ",(0,t.jsx)(n.a,{href:"https://www.keycloak.org/",children:"Keycloak"})," on a Cloud Container Engine (CCE) using an RDS PostgreSQL database for the supporting stateful storage. It guides through creating appropriate security groups, provisioning the database, and establishing DNS zones and endpoints. It covers all the necessary steps from provisioning the CCE cluster, deploying Keycloak secrets, application and services and exposing it externally using an ingress."]}),"\n",(0,t.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["a ",(0,t.jsx)(n.strong,{children:"Cloud Container Engine (CCE)"})," cluster"]}),"\n",(0,t.jsxs)(n.li,{children:["a PostgreSQL instance in ",(0,t.jsx)(n.strong,{children:"Relational Database Service (RDS)"})]}),"\n",(0,t.jsxs)(n.li,{children:["a bastion host in ",(0,t.jsx)(n.strong,{children:"Elastic Cloud Service (ECS)"})," (an Ubuntu instance will be used for this guide)"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"deploying-a-postgresql-with-rds",children:"Deploying a PostgreSQL with RDS"}),"\n",(0,t.jsx)(n.p,{children:"Keycloak, as a stateful workload, requires the presence of a persistent\nstorage in order to maintain its data and configuration during pod\nrestarts. We could deploy a PostgreSQL database as a CCE workload, but\nthis would require additional administrative overhead from your side.\nThe Managed Relational Database Service of Open Telekom Cloud is a\nperfect fit for this scenario. A scalable turn-key solution, that fully\nintegrated with the rest of managed services of the platform without\ndemanding from the consumer additional administrative effort."}),"\n",(0,t.jsx)(n.p,{children:"This step involves provisioning a PostgreSQL database instance via Open Telekom Cloud\u2019s RDS service. Select an instance class and storage configuration that align with your anticipated workload; consider factors such as expected connection volume, data growth, and performance requirements. For production environments, it's recommended to opt for a compute-optimized or memory-optimized instance class, along with provisioned IOPS storage if consistent performance is critical. This ensures that Keycloak operates reliably under load and can scale as demand increases."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"image",src:a(66366).A+"",width:"1918",height:"791"})}),"\n",(0,t.jsx)(n.p,{children:"When provisioning the PostgreSQL instance, ensure the following network and security configurations are in place:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Create two Security Groups, ",(0,t.jsx)(n.code,{children:"rds-instances"})," and ",(0,t.jsx)(n.code,{children:"rds-clients"}),", as described in best practice: ",(0,t.jsx)(n.a,{href:"/docs-next/pr-preview/pr-359/docs/best-practices/databases/relational-database-service/configure-sg-for-rds-instances",children:"Configure Security Groups for PostgreSQL RDS Instances and Clients"}),"."]}),"\n",(0,t.jsx)(n.li,{children:"Deploy the RDS instance within the same Virtual Private Cloud (VPC) as your CCE cluster to enable low-latency, private network communication between the application and the database."}),"\n",(0,t.jsxs)(n.li,{children:["Attach the previously created ",(0,t.jsx)(n.code,{children:"rds-instances"})," Security Group to the RDS instance. This group must allow inbound traffic on port ",(0,t.jsx)(n.code,{children:"5432"})," from the Subnet or Security Group associated with the CCE nodes to enable secure database access."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"image",src:a(44789).A+"",width:"2738",height:"954"})}),"\n",(0,t.jsx)(n.h3,{id:"creating-a-private-dns-zone",children:"Creating a Private DNS Zone"}),"\n",(0,t.jsxs)(n.p,{children:["We are provisioning PostgreSQL in order to support the functionality of\nKeycloak. For that matter, although Open Telekom Cloud employs this RDS\ninstance with a floating IP address, it would be better that we connect\nthe RDS instance with Keycloak via a fully qualified domain name and let\nthe Open Telekom Cloud's DNS service to manage the resolution of that\nendpoints. In the Domain Name Service management panel click ",(0,t.jsx)(n.em,{children:"Private\nZone"})," and create a new one that points to the VPC that CCE and RDS nodes\nare placed:"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"image",src:a(90340).A+"",width:"2312",height:"1240"})}),"\n",(0,t.jsxs)(n.p,{children:["and then click ",(0,t.jsx)(n.em,{children:"Manage Record Set"})," to add a new ",(0,t.jsx)(n.em,{children:"A Record"})," to this zone:"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"image",src:a(51622).A+"",width:"1654",height:"1286"})}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsx)(n.p,{children:"The domain name, will be a fictitious domain representing your solution\nand not a public one. It can be virtually any domain or subdomain that\nconforms to the a FQDN rules."})}),"\n",(0,t.jsx)(n.p,{children:"The floating IP of the RDS instance can be found in the Basic\nInformation panel of the database:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"image",src:a(37096).A+"",width:"2724",height:"1160"})}),"\n",(0,t.jsx)(n.h3,{id:"provisioning-a-database",children:"Provisioning a Database"}),"\n",(0,t.jsx)(n.p,{children:"Now as next, we need to provision a PostgreSQL database for the Keycloak installation. SSH to the bastion host and install the Postgres Client:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo apt update\nsudo apt install -y postgresql-client-14\n"})}),"\n",(0,t.jsx)(n.admonition,{title:"make sure...",type:"warning",children:(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"you've placed the bastion in the same VPC with the RDS nodes"}),"\n",(0,t.jsxs)(n.li,{children:["to assign ",(0,t.jsx)(n.code,{children:"rds-clients"})," as the Security Group for the bastion node"]}),"\n"]})}),"\n",(0,t.jsx)(n.p,{children:"Create the following file in your bastion host:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",metastring:'title="create-keycloak-db.sql"',children:"SELECT 'CREATE USER keycloak WITH PASSWORD ''<RDS_ADMIN_PASSWORD>'';'\nWHERE NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'keycloak')\n\\gexec\n\nSELECT 'CREATE DATABASE keycloak OWNER keycloak;'\nWHERE NOT EXISTS (SELECT 1 FROM pg_database WHERE datname = 'keycloak')\n\\gexec\n\nGRANT CONNECT, TEMPORARY ON DATABASE keycloak TO keycloak;\n\n\\connect keycloak\n\nCREATE SCHEMA IF NOT EXISTS kc AUTHORIZATION keycloak;\n\nGRANT USAGE, CREATE ON SCHEMA kc TO keycloak;\n\nALTER DEFAULT PRIVILEGES IN SCHEMA kc\nGRANT SELECT, INSERT, UPDATE, DELETE, REFERENCES, TRIGGER ON TABLES TO keycloak;\n\nALTER DEFAULT PRIVILEGES IN SCHEMA kc\nGRANT USAGE, SELECT, UPDATE ON SEQUENCES TO keycloak;\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"important",children:(0,t.jsxs)(n.p,{children:["Replace ",(0,t.jsx)(n.code,{children:"<RDS_ADMIN_PASSWORD>"})," with the value you provided in the previous step."]})}),"\n",(0,t.jsx)(n.p,{children:"and then let's create the necessary database, user and schema required by Keycloak:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"export PGPASSWORD='<RDS_ADMIN_PASSWORD>'\n\npsql \\\n  --host=<FQDN_PRIVATE_ZONE> \\\n  --port=5432 \\\n  --username=root \\\n  --dbname=postgres \\\n  --set=sslmode=require \\\n  --file=create-keycloak-db.sql\n\nunset PGPASSWORD\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"important",children:(0,t.jsxs)(n.p,{children:["Replace ",(0,t.jsx)(n.code,{children:"<RDS_ADMIN_PASSWORD>"})," and ",(0,t.jsx)(n.code,{children:"<FQDN_PRIVATE_ZONE>"})," with the values you configured in the previous steps."]})}),"\n",(0,t.jsx)(n.h2,{id:"provisioning-a-cce-cluster",children:"Provisioning a CCE Cluster"}),"\n",(0,t.jsx)(n.p,{children:"To proceed with the setup, you'll need to provision a Cloud Container Engine (CCE) cluster. Use the Open Telekom Cloud wizard for cluster creation, and pay close attention to the following configuration specifics:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"High Availability (HA)"}),": For this blueprint, a non HA-cluster was used which is not advised for production workloads. However, if your workload demands fault tolerance and availability guarantees, consider enabling HA during creation\u2014as this setting is immutable post-deployment."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Network Placement"}),": Ensure the CCE cluster is provisioned within the same VPC as the RDS instance to facilitate secure and low-latency communication."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Subnet Configuration"}),": If you're using a single Subnet for both services, place the CCE worker nodes in the same Subnet as the RDS instance to align with the predefined security group and routing rules."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"image",src:a(65988).A+"",width:"1884",height:"1046"})}),"\n",(0,t.jsxs)(n.p,{children:["Add worker nodes to the CCE cluster using the wizard, and wait all nodes\nto become operational. Then add to ",(0,t.jsx)(n.strong,{children:"each"})," node an additional Security\nGroup, in particular the ",(0,t.jsx)(n.code,{children:"rds-client"})," that we created earlier in this\nlab."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"image",src:a(6527).A+"",width:"2666",height:"1198"})}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsxs)(n.p,{children:["Make your own decision how you're going to access this CCE Cluster\nafterwards. You can assign an Elastic IP Address and access it over the\nInternet or provision and additional public-facing bastion host and\naccess it through this machine. ",(0,t.jsx)(n.strong,{children:"We categorically recommend the\nlatter"}),"."]})}),"\n",(0,t.jsx)(n.h2,{id:"deploying-keycloak",children:"Deploying Keycloak"}),"\n",(0,t.jsx)(n.p,{children:"We are going to deploy Keycloak using simple Kubernetes manifests.\nDeploy the following YAML manifests in the order described below using kubectl\non your bastion host, or in any other machine if you chose to go\nfor an EIP."}),"\n",(0,t.jsx)(n.p,{children:"First we are going to need a Namespace in our CCE Cluster, in order to\ndeploy all the resources required by Keycloak:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"kubectl create namespace keycloak\n"})}),"\n",(0,t.jsx)(n.h3,{id:"deploying-secrets",children:"Deploying Secrets"}),"\n",(0,t.jsxs)(n.p,{children:["We are going to need two Secrets. One, ",(0,t.jsx)(n.code,{children:"postgres-credentials"}),", that will\ncontain the credentials to access the PostgreSQL database instance and a\nsecond one, ",(0,t.jsx)(n.code,{children:"keycloak-secrets"}),", that will contain the necessary\ncredential to access the web console of Keycloak:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="credentials.yaml"',children:"apiVersion: v1\nkind: Secret\nmetadata:\n  name: postgres-credentials\n  namespace: keycloak\ntype: Opaque\nstringData:\n  POSTGRES_USER: root\n  POSTGRES_PASSWORD: <RDS_ADMIN_PASSWORD>\n  POSTGRES_DB: keycloak\n  POSTGRES_SCHEMA: kc\n---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: keycloak-secrets\n  namespace: keycloak\ntype: Opaque\nstringData:\n  KEYCLOAK_ADMIN: admin\n  KEYCLOAK_ADMIN_PASSWORD: <KC_BOOTSTRAP_ADMIN_PASSWORD>\n"})}),"\n",(0,t.jsxs)(n.admonition,{type:"note",children:[(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"RDS_ADMIN_PASSWORD"})," is the password for the ",(0,t.jsx)(n.code,{children:"root"})," user your provided\nduring the creation of the RDS instance. Set ",(0,t.jsx)(n.code,{children:"KC_BOOTSTRAP_ADMIN_PASSWORD"})," as the password\nfor the temporary Keycloak ",(0,t.jsx)(n.code,{children:"admin"})," bootstrap account."]}),(0,t.jsx)(n.p,{children:"You can easily createrandom strong passwords, in Linux terminal, with the following command:"}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"openssl rand -base64 14\n"})})]}),"\n",(0,t.jsx)(n.h3,{id:"deploying-application",children:"Deploying Application"}),"\n",(0,t.jsxs)(n.p,{children:["Next step, is deploying Keycloak itself as a ",(0,t.jsx)(n.code,{children:"Statefulset"})," with 2 replicas:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="keycloak-sts.yaml"',children:'apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: keycloak\n  namespace: keycloak\n  labels:\n    app: keycloak\nspec:\n  serviceName: keycloak-discovery\n  replicas: 2\n  selector:\n    matchLabels:\n      app: keycloak\n  template:\n    metadata:\n      labels:\n        app: keycloak\n    spec:\n      containers:\n        - name: keycloak\n          image: quay.io/keycloak/keycloak:26.4.0\n          args: ["start"]\n          env:\n            - name: KC_LOG_LEVEL\n              value: DEBUG\n            - name: KC_DB\n              value: "postgres"\n            - name: POSTGRES_DB\n              valueFrom:\n                secretKeyRef:\n                  name: postgres-credentials\n                  key: POSTGRES_DB\n            - name: POSTGRES_SCHEMA\n              valueFrom:\n                secretKeyRef:\n                  name: postgres-credentials\n                  key: POSTGRES_SCHEMA\n            - name: KC_DB_URL\n              value: jdbc:postgresql://<FQDN_PRIVATE_ZONE>:5432/$(POSTGRES_DB)?currentSchema=$(POSTGRES_SCHEMA)\n            - name: KC_DB_USERNAME\n              valueFrom:\n                secretKeyRef:\n                  name: postgres-credentials\n                  key: POSTGRES_USER\n            - name: KC_DB_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  name: postgres-credentials\n                  key: POSTGRES_PASSWORD\n            - name: KC_BOOTSTRAP_ADMIN_USERNAME\n              valueFrom:\n                secretKeyRef:\n                  key: KEYCLOAK_ADMIN\n                  name: keycloak-secrets\n            - name: KC_BOOTSTRAP_ADMIN_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  key: KEYCLOAK_ADMIN_PASSWORD\n                  name: keycloak-secrets\n            - name: KC_PROXY_HEADERS\n              value: "xforwarded"\n            - name: KC_HTTP_ENABLED\n              value: "true"\n            - name: KC_HOSTNAME\n              value: "<FQDN_PUBLIC_ADDRESS>"\n            - name: KC_HOSTNAME_STRICT\n              value: "false"\n            - name: KC_HEALTH_ENABLED\n              value: "true"\n            - name: KC_CACHE\n              value: \'ispn\'\n            - name: KC_CACHE_STACK\n              value: \'kubernetes\'\n            - name: POD_IP\n              valueFrom:\n                fieldRef:\n                  fieldPath: status.podIP\n            - name: JAVA_OPTS_APPEND\n              value: \'-Djgroups.dns.query="keycloak-discovery" -Djgroups.bind.address=$(POD_IP)\'\n          ports:\n            - name: http\n              containerPort: 8080\n          startupProbe:\n            httpGet:\n              path: /health/started\n              port: 9000\n            periodSeconds: 1\n            failureThreshold: 600              \n          readinessProbe:\n            httpGet:\n              path: /health/ready\n              port: 9000\n            periodSeconds: 10\n            failureThreshold: 3              \n          livenessProbe:\n            httpGet:\n              path: /health/live\n              port: 9000\n            periodSeconds: 10\n            failureThreshold: 3              \n          resources:\n            requests:\n              memory: "1Gi"\n              cpu: "512m"\n            limits:\n              memory: "1Gi"\n              cpu: "512m"\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: keycloak\n  namespace: keycloak\n  labels:\n    app: keycloak\nspec:\n  ports:\n    - protocol: TCP\n      port: 8080\n      targetPort: http\n      name: http\n  selector:\n    app: keycloak\n  type: ClusterIP\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: keycloak-discovery\n  namespace: keycloak\n  labels:\n    app: keycloak\nspec:\n  selector:\n    app: keycloak\n  publishNotReadyAddresses: true\n  clusterIP: None\n  type: ClusterIP\n'})}),"\n",(0,t.jsx)(n.admonition,{type:"important",children:(0,t.jsxs)(n.p,{children:["Replace ",(0,t.jsx)(n.code,{children:"<FQDN_PRIVATE_ZONE>"})," & ",(0,t.jsx)(n.code,{children:"FQDN_PUBLIC_ADDRESS"})," with the values you configured in the previous steps."]})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f keycloak-sts.yaml\n"})}),"\n",(0,t.jsx)(n.h3,{id:"deploying-ingress",children:"Deploying Ingress"}),"\n",(0,t.jsxs)(n.admonition,{type:"important",children:[(0,t.jsx)(n.p,{children:"Before deploying the Ingress, the CCE cluster must be equipped with a set of foundational components. You will need to  install and configure essential prerequisites such as the NGINX Ingress Controller for routing external traffic, cert-manager for managing TLS certificates, and other supporting workloads. These components establish the baseline infrastructure required to expose services securely and ensure smooth operation of the application stack within the Kubernetes environment."}),(0,t.jsxs)(n.p,{children:["Follow the guidelines in the best practice ",(0,t.jsx)(n.a,{href:"/docs/best-practices/containers/cloud-container-engine/enabling-external-traffic-with-ingress-and-tls",children:"Enabling External Traffic with Ingress & TLS"})," before proceeding to the next steps."]})]}),"\n",(0,t.jsxs)(n.p,{children:["And finally, the last step of this guide is to deploy an ",(0,t.jsx)(n.code,{children:"Ingress"})," to expose Keycloak workload:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="keycloak-ingress.yaml"',children:"apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: keycloak-ingress\n  namespace: keycloak\n  annotations:\n    cert-manager.io/cluster-issuer: opentelekomcloud-letsencrypt\nspec:\n  ingressClassName: nginx\n  tls:\n    - hosts:\n        - <FQDN_PUBLIC_ADDRESS>\n      secretName: keycloak-tls\n  rules:\n    - host: <FQDN_PUBLIC_ADDRESS>\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: keycloak\n                port:\n                  number: 8080\n"})}),"\n",(0,t.jsxs)(n.p,{children:["replace ",(0,t.jsx)(n.code,{children:"<FQDN_PUBLIC_ADDRESS>"})," with the public address of your instance and apply the manifest with ",(0,t.jsx)(n.strong,{children:"kubectl"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f keycloak-ingress.yaml\n"})}),"\n",(0,t.jsx)(n.p,{children:"We can now open the url address we defined in our Public DNS Zone for\nthis application and land on the welcome page of Keycloak:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"image",src:a(51273).A+"",width:"2864",height:"1342"})}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(n.h3,{id:"drop-database",children:"Drop Database"}),"\n",(0,t.jsx)(n.p,{children:"In your bastion host create the following file:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",metastring:'title="rollback-keycloak-db.sql"',children:"REVOKE CONNECT ON DATABASE keycloak FROM keycloak;\n\nSELECT pg_terminate_backend(pid)\nFROM pg_stat_activity\nWHERE datname = 'keycloak';\n\nDROP DATABASE IF EXISTS keycloak;\nDROP ROLE IF EXISTS keycloak;\n"})}),"\n",(0,t.jsx)(n.p,{children:"and execute the following commands in order to clean the database and schema and start over:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"export PGPASSWORD='<RDS_ADMIN_PASSWORD>'\n\npsql \\\n  --host=<FQDN_PRIVATE_ZONE> \\\n  --port=5432 \\\n  --username=root \\\n  --dbname=postgres \\\n  --set=sslmode=require \\\n  --file=rollback-keycloak-db.sql\n\nunset PGPASSWORD\n"})})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},44789:(e,n,a)=>{a.d(n,{A:()=>s});const s=a.p+"assets/images/SCR-20231208-ka7-c4da47db72eb78e7b3db4ab32b2107ae.png"},90340:(e,n,a)=>{a.d(n,{A:()=>s});const s=a.p+"assets/images/SCR-20231211-f5u-7a85e011210a573a141dfcb1fe2cbb37.png"},51622:(e,n,a)=>{a.d(n,{A:()=>s});const s=a.p+"assets/images/SCR-20231211-ffb-c3e1bcc9f3ab9c8d78008f5b466cb91f.png"},37096:(e,n,a)=>{a.d(n,{A:()=>s});const s=a.p+"assets/images/SCR-20231211-fj8-4eb6e51091814ee6b12cb632394f5fe2.png"},65988:(e,n,a)=>{a.d(n,{A:()=>s});const s=a.p+"assets/images/SCR-20231211-fp6-8a560149b7f7389e0dccb3d85317b310.png"},6527:(e,n,a)=>{a.d(n,{A:()=>s});const s=a.p+"assets/images/SCR-20231211-g7y-fd08313314be51ab168179be8402cf02.png"},51273:(e,n,a)=>{a.d(n,{A:()=>s});const s=a.p+"assets/images/SCR-20260201-f1u-c94e9119b5a1db7e0fbf775923db1159.png"},66366:(e,n,a)=>{a.d(n,{A:()=>s});const s=a.p+"assets/images/Screenshot_from_2025-04-16_10-54-16-2f0631d8cb9a7235c63756bd46aaee6c.png"},28453:(e,n,a)=>{a.d(n,{R:()=>o,x:()=>r});var s=a(96540);const t={},i=s.createContext(t);function o(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);